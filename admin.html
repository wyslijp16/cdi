<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 50px;
        }
        /* Styles pour le bouton burger */
        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 10001; /* Au-dessus de tout */
            background-color: #4338ca; /* indigo-700 */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s;
        }
        #hamburger-button:hover {
            background-color: #3730a3; /* indigo-800 */
        }
        /* Styles pour le menu latéral */
        #sidebar-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 256px; /* w-64 */
            background-color: #3730a3; /* indigo-800 */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(-100%); /* Masqué par défaut */
            transition: transform 0.3s ease-in-out;
            z-index: 10000; /* Juste en dessous du bouton burger */
            padding: 1rem;
            padding-top: 5rem; /* Espace pour le bouton burger */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #sidebar-menu.open {
            transform: translateX(0); /* Visible */
        }
        .menu-button {
            text-align: left;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            color: white;
            transition: background-color 0.2s;
            width: 100%; /* S'assure que le bouton prend toute la largeur */
        }
        .menu-button:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .menu-button.active-section-button {
            background-color: #4338ca; /* indigo-700 */
        }

        /* Ajustement du padding de la main pour ne pas être caché par le menu */
        main {
            padding-left: 1rem; /* Padding par défaut */
            transition: padding-left 0.3s ease-in-out;
        }
        /* Si le menu est ouvert, le contenu principal ne doit pas être caché */
        /* Ceci est plus complexe car le menu overlay. L'important est que le contenu soit visible. */
        /* Si le menu était "pushing", on ajusterait le padding ici. */


        .pending-card, .resource-card, .category-config-card {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .pending-card.fade-out, .resource-card.fade-out, .category-config-card.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        .pending-card h3, .resource-card h3, .category-config-card h3 {
            font-weight: 600;
            color: #4338ca;
            font-size: 1.25rem;
        }
        .pending-card p, .resource-card p, .category-config-card p {
            color: #4b5563;
        }
        .pending-card .actions, .resource-card .actions, .category-config-card .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pending-card .actions button, .resource-card .actions button, .category-config-card .actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .pending-card .actions .btn-validate, .resource-card .actions .btn-edit, .category-config-card .actions .btn-edit-category {
            background-color: #10b981; /* emerald-500 */
        }
        .pending-card .actions .btn-validate:hover, .resource-card .actions .btn-edit:hover, .category-config-card .actions .btn-edit-category:hover {
            background-color: #059669; /* emerald-600 */
        }
        .pending-card .actions .btn-reject, .resource-card .actions .btn-delete, .category-config-card .actions .btn-delete-category {
            background-color: #ef4444; /* red-500 */
        }
        .pending-card .actions .btn-reject:hover, .resource-card .actions .btn-delete:hover, .category-config-card .actions .btn-delete-category:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Styles pour le message sur la carte */
        .card-message-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            pointer-events: none;
            z-index: 10;
        }
        .card-message-area.show {
            opacity: 1;
        }
        .card-message-area.success {
            background-color: rgba(16, 185, 129, 0.9);
        }
        .card-message-area.error {
            background-color: rgba(239, 68, 68, 0.9);
        }

        /* Styles pour le modal d'édition */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            visibility: hidden;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            width: 90%;
            max-height: 90vh; /* Hauteur maximale de la modale */
            overflow-y: auto; /* Ajoute une barre de défilement si le contenu dépasse */
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        .modal-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .modal-form-group input, .modal-form-group textarea, .modal-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .modal-form-group input:focus, .modal-form-group textarea:focus, .modal-form-group select:focus {
            outline: none;
            border-color: #4338ca;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .modal-buttons .btn-save {
            background-color: #2563eb; /* blue-600 */
        }
        .modal-buttons .btn-save:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .modal-buttons .btn-cancel {
            background-color: #6b7280; /* gray-500 */
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .modal-buttons .btn-delete-resource {
            background-color: #ef4444; /* red-500 */
            margin-right: auto; /* Aligne à gauche */
        }
        .modal-buttons .btn-delete-resource:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Styles pour la gestion des filtres */
        .filter-property-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
        }
        .filter-property-item input {
            flex-grow: 1;
            margin-bottom: 0 !important; /* Override modal-form-group margin */
        }
        .filter-property-item button {
            background-color: #dc2626; /* red-600 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: normal;
        }
        
        /* Nouveaux styles pour la page de connexion */
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Conteneur de connexion -->
    <div id="login-container" class="login-container p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full border border-gray-200">
            <h2 class="text-3xl font-bold text-center mb-6 text-indigo-700">Panneau d'administration</h2>
            <p class="text-center text-gray-500 mb-6">Connectez-vous pour accéder au tableau de bord.</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" autocomplete="email" class="mt-1 block w-full p-3 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <input type="password" id="password" autocomplete="current-password" class="mt-1 block w-full p-3 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-md text-white font-semibold bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    Se connecter
                </button>
            </form>
            <div id="login-message" class="mt-4 p-3 bg-red-100 text-red-700 rounded-md hidden"></div>
        </div>
    </div>


    <!-- Conteneur principal du panneau d'administration (initialement masqué) -->
    <div id="admin-panel-container" class="hidden">
        <!-- Bouton Burger -->
        <button id="hamburger-button">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <!-- Menu Latéral -->
        <nav id="sidebar-menu">
            <div class="flex items-center space-x-4 mb-4">
                <div class="text-right text-sm">
                    <p class="font-bold text-lg" id="user-role-menu"></p>
                    <p class="text-gray-300" id="user-email-menu"></p>
                </div>
            </div>
            <button id="menu-btn-show-welcome" class="menu-button">Accueil</button>
            <!-- Bouton pour les propositions en attente (visible pour tous les rôles admin) -->
            <button id="menu-btn-show-pending" class="menu-button">Propositions en attente</button>
            <!-- Boutons pour les superusers seulement -->
            <div id="superuser-menu-items" class="hidden">
                <button id="menu-btn-show-manage" class="menu-button">Gérer les ressources existantes</button>
                <button id="menu-btn-show-config" class="menu-button">Gérer Catégories/Filtres</button>
            </div>
            <div class="mt-auto pt-4 border-t border-indigo-600">
                <button id="logout-btn" class="menu-button bg-red-500 hover:bg-red-600">
                    Déconnexion
                </button>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8">
            <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">Panneau d'Administration CDI</h1>

            <!-- Zone d'affichage des messages généraux -->
            <div id="general-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>

            <!-- Section de bienvenue (nouvelle section, visible par défaut) -->
            <div id="welcome-section" class="text-center bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Bienvenue sur le Panneau d'Administration du CDI !</h2>
                <p class="text-lg text-gray-700 mb-4">
                    Utilisez ce panneau pour gérer les ressources du Centre de Documentation et d'Information de L'ékip Teknik.
                </p>
                <p class="text-md text-gray-600">
                    Sélectionnez une option dans le menu latéral (cliquez sur l'icône <svg class="inline-block w-5 h-5 align-middle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> en haut à gauche) pour commencer. Vous pourrez valider ou refuser les **propositions en attente**, modifier ou supprimer les **ressources existantes**, et gérer les **catégories et leurs propriétés de filtre**.
                </p>
            </div>

            <!-- Section des propositions en attente -->
            <div id="pending-suggestions-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Propositions en attente de validation</h2>
                <div id="pending-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>
                </div>
            </div>

            <!-- Section de gestion des ressources existantes (initialement cachée) -->
            <div id="manage-resources-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Gérer les ressources existantes</h2>
                <div id="resources-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des ressources...</p>
                </div>
            </div>

            <!-- Section de gestion des catégories et filtres (initialement cachée) -->
            <div id="manage-config-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Gérer les catégories et leurs filtres</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">Catégories actuelles</h3>
                    <div id="categories-config-list" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">Chargement de la configuration...</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Ajouter une nouvelle catégorie</h3>
                    <form id="add-category-form">
                        <div class="modal-form-group">
                            <label for="new-category-id">ID de la catégorie (ex: petitions)</label>
                            <input type="text" id="new-category-id" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-label">Libellé de la catégorie (ex: Pétitions)</label>
                            <input type="text" id="new-category-label" required>
                        </div>
                        <h4 class="font-semibold mt-4 mb-2">Propriétés de filtre (ID et Libellé)</h4>
                        <div id="new-category-filter-properties">
                            <!-- Les champs de filtre seront ajoutés ici -->
                        </div>
                        <button type="button" id="add-filter-property-button" class="bg-blue-500 text-white py-2 px-4 rounded-md mt-2 hover:bg-blue-600">Ajouter une propriété de filtre</button>
                        <button type="submit" class="bg-emerald-500 text-white py-2 px-4 rounded-md mt-4 ml-2 hover:bg-emerald-600">Ajouter la catégorie</button>
                    </form>
                </div>
            </div>


            <!-- Modal d'édition de ressource (initialement caché) -->
            <div id="edit-resource-modal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-button" id="close-resource-modal-button">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-center text-indigo-700">Modifier la ressource</h3>
                    <form id="edit-resource-form">
                        <input type="hidden" id="edit-resource-id">
                        <div class="modal-form-group">
                            <label for="edit-title">Titre</label>
                            <input type="text" id="edit-title" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-description">Description</label>
                            <textarea id="edit-description" rows="3" required></textarea>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-url">URL</label>
                            <input type="url" id="edit-url" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-category">Catégorie</label>
                            <select id="edit-category" required>
                                <!-- Les options seront chargées dynamiquement -->
                            </select>
                        </div>
                        <!-- Champs spécifiques pour l'édition (générés dynamiquement) -->
                        <div id="edit-specific-fields"></div>

                        <div class="modal-buttons">
                            <button type="button" id="delete-resource-button" class="btn-delete-resource">Supprimer la ressource</button>
                            <button type="button" id="cancel-edit-button" class="btn-cancel">Annuler</button>
                            <button type="submit" class="btn-save">Enregistrer les modifications</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal d'édition de catégorie (initialement caché) -->
            <div id="edit-category-modal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-button" id="close-category-modal-button">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-center text-indigo-700">Modifier les filtres de la catégorie</h3>
                    <form id="edit-category-form">
                        <input type="hidden" id="edit-category-key">
                        <div class="modal-form-group">
                            <label for="edit-category-modal-label">Libellé de la catégorie</label>
                            <input type="text" id="edit-category-modal-label" disabled> <!-- L'ID de la catégorie n'est pas modifiable -->
                        </div>
                        <h4 class="font-semibold mt-4 mb-2">Propriétés de filtre</h4>
                        <div id="edit-category-filter-properties-list">
                            <!-- Les champs de filtre existants seront affichés ici -->
                        </div>
                        <button type="button" id="add-edit-filter-property-button" class="bg-blue-500 text-white py-2 px-4 rounded-md mt-2 hover:bg-blue-600">Ajouter une propriété de filtre</button>
                        <div class="modal-buttons">
                            <button type="button" id="cancel-category-edit-button" class="btn-cancel">Annuler</button>
                            <button type="submit" class="btn-save">Enregistrer les modifications</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Importation des fonctions nécessaires depuis les SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";


        // VOTRE CONFIGURATION FIREBASE
        // Votre configuration Firebase (DOIT être la même que dans votre index.html)
        const firebaseConfig = { apiKey: "AIzaSyAKoEX-Sdn1KQ78wYZCAz001vKiRBoT46w", authDomain: "cdi-lfi.firebaseapp.com", projectId: "cdi-lfi", storageBucket: "cdi-lfi.firebasestorage.app", messagingSenderId: "626855610699", appId: "1:626855610699:web:3c46a96f9d77d3e150c0ce", measurementId: "G-EMXFSRL9W0" };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);


        // =================================================================================================
        //                                     ÉLÉMENTS D'AUTHENTIFICATION
        // =================================================================================================
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const adminPanelContainer = document.getElementById('admin-panel-container');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailMenu = document.getElementById('user-email-menu');
        const userRoleMenu = document.getElementById('user-role-menu');
        const superuserMenuItems = document.getElementById('superuser-menu-items');
        
        /**
         * Récupère le rôle de l'utilisateur depuis Firestore.
         * @param {string} uid - L'ID de l'utilisateur.
         * @returns {Promise<string|null>} Le rôle de l'utilisateur ('moderator', 'superuser') ou null.
         */
        async function getUserRole(uid) {
            try {
                const userDocRef = doc(db, 'users', uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    return userDoc.data().role;
                }
                return null;
            } catch (error) {
                console.error("Erreur lors de la récupération du rôle : ", error);
                return null;
            }
        }
    
        /**
         * Met à jour l'interface utilisateur en fonction de l'état de l'authentification et du rôle.
         * @param {object} user - L'objet utilisateur de Firebase, ou null.
         */
        async function updateUI(user) {
            if (user) {
                const role = await getUserRole(user.uid);
                if (role && (role === 'moderator' || role === 'superuser')) {
                    loginContainer.classList.add('hidden');
                    adminPanelContainer.classList.remove('hidden');
                    userEmailMenu.textContent = user.email;
                    userRoleMenu.textContent = role === 'moderator' ? 'Modérateur·trice' : 'SuperUser';
                    
                    // Afficher les éléments du menu appropriés
                    superuserMenuItems.classList.toggle('hidden', role !== 'superuser');
                    showSection('welcome'); // Affiche l'écran de bienvenue une fois la connexion établie

                } else {
                    // Utilisateur authentifié mais sans rôle ou rôle incorrect, déconnexion forcée
                    await signOut(auth);
                    loginMessage.textContent = "Accès refusé. Vos privilèges sont insuffisants.";
                    loginMessage.classList.remove('hidden');
                }
            } else {
                loginContainer.classList.remove('hidden');
                adminPanelContainer.classList.add('hidden');
                loginMessage.classList.add('hidden');
                loginForm.reset();
            }
        }
    
        // Gérer l'état d'authentification initial et les changements
        onAuthStateChanged(auth, updateUI);
    
        // Écouteur pour la soumission du formulaire de connexion
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginMessage.classList.add('hidden');
    
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // La fonction onAuthStateChanged se chargera de l'UI
            } catch (error) {
                console.error(error);
                loginMessage.textContent = "Erreur de connexion. Veuillez vérifier votre email et mot de passe.";
                loginMessage.classList.remove('hidden');
            }
        });
    
        // Écouteur pour le bouton de déconnexion
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            // La fonction onAuthStateChanged se chargera de l'UI
        });
        
        // =================================================================================================
        //                      LOGIQUE PRÉ-EXISTANTE (Légèrement modifiée)
        // =================================================================================================
        
        // Références aux éléments DOM
        const hamburgerButton = document.getElementById('hamburger-button');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const menuButtons = document.querySelectorAll('.menu-button');
        const generalMessageArea = document.getElementById('general-message-area');
        const welcomeSection = document.getElementById('welcome-section');
        const pendingSuggestionsSection = document.getElementById('pending-suggestions-section');
        const manageResourcesSection = document.getElementById('manage-resources-section');
        const manageConfigSection = document.getElementById('manage-config-section');
        const pendingSuggestionsList = document.getElementById('pending-suggestions-list');
        const resourcesList = document.getElementById('resources-list');
        const categoriesConfigList = document.getElementById('categories-config-list');
        const editResourceModal = document.getElementById('edit-resource-modal');
        const editResourceForm = document.getElementById('edit-resource-form');
        const closeResourceModalButton = document.getElementById('close-resource-modal-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const deleteResourceButton = document.getElementById('delete-resource-button');
        // Champs du formulaire d'édition de ressource
        const editResourceId = document.getElementById('edit-resource-id');
        const editTitle = document.getElementById('edit-title');
        const editDescription = document.getElementById('edit-description');
        const editUrl = document.getElementById('edit-url');
        const editCategory = document.getElementById('edit-category');
        const editSpecificFieldsContainer = document.getElementById('edit-specific-fields');
        // Formulaire d'ajout de catégorie
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryIdInput = document.getElementById('new-category-id');
        const newCategoryLabelInput = document.getElementById('new-category-label');
        const newCategoryFilterPropertiesContainer = document.getElementById('new-category-filter-properties');
        const addFilterPropertyButton = document.getElementById('add-filter-property-button');
        // Modal d'édition de catégorie
        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryForm = document.getElementById('edit-category-form');
        const closeCategoryModalButton = document.getElementById('close-category-modal-button');
        const cancelCategoryEditButton = document.getElementById('cancel-category-edit-button');
        const editCategoryKeyInput = document.getElementById('edit-category-key');
        const editCategoryModalLabelInput = document.getElementById('edit-category-modal-label');
        const editCategoryFilterPropertiesList = document.getElementById('edit-category-filter-properties-list');
        const addEditFilterPropertyButton = document.getElementById('add-edit-filter-property-button');
        let unsubscribePendingSnapshot = null;
        let unsubscribeResourcesSnapshot = null;
        let unsubscribeConfigSnapshot = null;
        
        let categoryConfigData = {};
        
        // Fonction pour afficher une section
        function showSection(sectionId) {
            // Masquer toutes les sections
            [welcomeSection, pendingSuggestionsSection, manageResourcesSection, manageConfigSection].forEach(section => {
                if (section) section.classList.add('hidden');
            });
        
            // Désactiver tous les boutons de menu
            menuButtons.forEach(button => button.classList.remove('active-section-button'));
        
            // Afficher la section demandée et activer le bouton correspondant
            if (sectionId === 'welcome') {
                welcomeSection.classList.remove('hidden');
                document.getElementById('menu-btn-show-welcome').classList.add('active-section-button');
                // Nettoyer les listeners des autres sections
                if (unsubscribePendingSnapshot) unsubscribePendingSnapshot();
                if (unsubscribeResourcesSnapshot) unsubscribeResourcesSnapshot();
                if (unsubscribeConfigSnapshot) unsubscribeConfigSnapshot();
            } else if (sectionId === 'pending') {
                pendingSuggestionsSection.classList.remove('hidden');
                document.getElementById('menu-btn-show-pending').classList.add('active-section-button');
                // Nettoyer les listeners des autres sections
                if (unsubscribeResourcesSnapshot) unsubscribeResourcesSnapshot();
                if (unsubscribeConfigSnapshot) unsubscribeConfigSnapshot();
                // Charger la section "Pending"
                loadPendingSuggestions();
            } else if (sectionId === 'manage') {
                manageResourcesSection.classList.remove('hidden');
                document.getElementById('menu-btn-show-manage').classList.add('active-section-button');
                // Nettoyer les listeners des autres sections
                if (unsubscribePendingSnapshot) unsubscribePendingSnapshot();
                if (unsubscribeConfigSnapshot) unsubscribeConfigSnapshot();
                // Charger la section "Manage"
                loadResources();
            } else if (sectionId === 'config') {
                manageConfigSection.classList.remove('hidden');
                document.getElementById('menu-btn-show-config').classList.add('active-section-button');
                // Nettoyer les listeners des autres sections
                if (unsubscribePendingSnapshot) unsubscribePendingSnapshot();
                if (unsubscribeResourcesSnapshot) unsubscribeResourcesSnapshot();
                // Charger la section "Config"
                loadCategoryConfig();
            }
        
            // Fermer le menu après la sélection sur mobile
            sidebarMenu.classList.remove('open');
        }
        
        // Fonction pour afficher un message général
        function showGeneralMessage(message, type = 'info') {
            generalMessageArea.textContent = message;
            generalMessageArea.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            if (type === 'success') {
                generalMessageArea.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                generalMessageArea.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => generalMessageArea.classList.add('hidden'), 5000);
        }
        
        // ================================================
        //            FONCTIONS POUR LES SECTIONS
        // ================================================
        
        // Fonction pour charger les suggestions en attente (onSnapshot)
        function loadPendingSuggestions() {
            if (unsubscribePendingSnapshot) unsubscribePendingSnapshot();
            pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>';
        
            const q = collection(db, 'pending_suggestions');
            unsubscribePendingSnapshot = onSnapshot(q, (snapshot) => {
                const pendingItems = [];
                snapshot.forEach(doc => pendingItems.push({ id: doc.id, ...doc.data() }));
                
                renderPendingSuggestions(pendingItems);
        
            }, (error) => {
                console.error("Error loading pending suggestions: ", error);
                pendingSuggestionsList.innerHTML = `<p class="col-span-full text-center text-red-500 text-xl mt-12">Erreur lors du chargement des propositions.</p>`;
            });
        }
        
        // Fonction pour rendre les suggestions
        function renderPendingSuggestions(items) {
            pendingSuggestionsList.innerHTML = '';
            if (items.length === 0) {
                pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune proposition en attente.</p>';
                return;
            }
        
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'pending-card';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <div class="actions">
                        <button class="btn-validate" data-action="validate">Valider</button>
                        <button class="btn-reject" data-action="reject">Rejeter</button>
                    </div>
                    <div class="card-message-area"></div>
                `;
                pendingSuggestionsList.appendChild(card);
            });
        }
        
        // Fonction pour charger les ressources existantes (onSnapshot)
        function loadResources() {
            if (unsubscribeResourcesSnapshot) unsubscribeResourcesSnapshot();
            resourcesList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des ressources...</p>';
        
            const q = collection(db, 'resources');
            unsubscribeResourcesSnapshot = onSnapshot(q, (snapshot) => {
                const resources = [];
                snapshot.forEach(doc => resources.push({ id: doc.id, ...doc.data() }));
                
                renderResources(resources);
        
            }, (error) => {
                console.error("Error loading resources: ", error);
                resourcesList.innerHTML = `<p class="col-span-full text-center text-red-500 text-xl mt-12">Erreur lors du chargement des ressources.</p>`;
            });
        }
        
        // Fonction pour rendre les ressources existantes
        function renderResources(items) {
            resourcesList.innerHTML = '';
            if (items.length === 0) {
                resourcesList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune ressource existante.</p>';
                return;
            }
        
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <div class="actions">
                        <button class="btn-edit" data-action="edit">Modifier</button>
                        <button class="btn-delete" data-action="delete">Supprimer</button>
                    </div>
                `;
                resourcesList.appendChild(card);
            });
        }
        
        // Fonction pour charger la configuration des catégories (onSnapshot)
        function loadCategoryConfig() {
            if (unsubscribeConfigSnapshot) unsubscribeConfigSnapshot();
            categoriesConfigList.innerHTML = '<p class="text-gray-500">Chargement de la configuration...</p>';
        
            const docRef = doc(db, 'appConfig', 'categoriesAndFilters');
            unsubscribeConfigSnapshot = onSnapshot(docRef, (docSnap) => {
                categoryConfigData = docSnap.exists() ? docSnap.data() : {};
                renderCategoryConfig(categoryConfigData);
            }, (error) => {
                console.error("Error loading category config: ", error);
                categoriesConfigList.innerHTML = '<p class="text-red-500">Erreur lors du chargement de la configuration.</p>';
                categoryConfigData = {};
            });
        }
        
        // Fonction pour rendre la configuration des catégories
        function renderCategoryConfig(config) {
            categoriesConfigList.innerHTML = '';
            if (Object.keys(config).length === 0) {
                categoriesConfigList.innerHTML = '<p class="text-gray-500">Aucune catégorie configurée.</p>';
                return;
            }
        
            for (const categoryId in config) {
                const category = config[categoryId];
                const card = document.createElement('div');
                card.className = 'category-config-card';
                card.dataset.id = categoryId;
                
                let filtersHtml = '';
                if (category.filters) {
                    filtersHtml = Object.entries(category.filters).map(([id, label]) => `
                        <li class="bg-gray-100 p-2 rounded-md text-sm">${label} (${id})</li>
                    `).join('');
                }
        
                card.innerHTML = `
                    <h3>${category.label} (${categoryId})</h3>
                    <p class="font-semibold mt-2">Filtres :</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">${filtersHtml || '<p class="text-gray-500 text-sm">Aucun filtre.</p>'}</ul>
                    <div class="actions">
                        <button class="btn-edit-category" data-action="edit-category">Modifier les filtres</button>
                        <button class="btn-delete-category" data-action="delete-category">Supprimer la catégorie</button>
                    </div>
                `;
                categoriesConfigList.appendChild(card);
            }
        }
        
        
        // Fonction utilitaire pour vider et remplir les champs d'un formulaire
        function fillFormWithData(form, data) {
            for (const key in data) {
                const input = form.querySelector(`#edit-${key}`);
                if (input) {
                    input.value = data[key];
                }
            }
        }
        
        // Fonction pour générer dynamiquement les champs de filtre d'une ressource
        function generateEditSpecificFields(categoryKey, resourceData) {
            editSpecificFieldsContainer.innerHTML = '';
            const categoryConfig = categoryConfigData[categoryKey];
            if (!categoryConfig || !categoryConfig.filters) return;
        
            for (const filterId in categoryConfig.filters) {
                const filterLabel = categoryConfig.filters[filterId];
                const div = document.createElement('div');
                div.className = 'modal-form-group';
                div.innerHTML = `
                    <label for="edit-filter-${filterId}">${filterLabel}</label>
                    <input type="text" id="edit-filter-${filterId}" value="${resourceData.filters ? (resourceData.filters[filterId] || '') : ''}">
                `;
                editSpecificFieldsContainer.appendChild(div);
            }
        }
        
        // Fonction pour générer un champ de filtre dans le formulaire d'ajout/édition de catégorie
        function addFilterPropertyField(container, id = '', label = '') {
            const wrapper = document.createElement('div');
            wrapper.className = 'filter-property-item';
            wrapper.innerHTML = `
                <input type="text" class="filter-id-input" placeholder="ID (ex: type)" value="${id}" required>
                <input type="text" class="filter-label-input" placeholder="Libellé (ex: Type de ressource)" value="${label}" required>
                <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold p-1 rounded-full text-xs" onclick="this.parentElement.remove()">
                    &times;
                </button>
            `;
            container.appendChild(wrapper);
        }
        
        // Gestion des événements du menu
        hamburgerButton.addEventListener('click', () => {
            sidebarMenu.classList.toggle('open');
        });
        
        menuButtons.forEach(button => {
            button.addEventListener('click', () => {
                const sectionId = button.id.replace('menu-btn-show-', '');
                showSection(sectionId);
            });
        });
        
        // Écouteur pour le modal d'édition de ressource
        closeResourceModalButton.addEventListener('click', () => editResourceModal.classList.remove('show'));
        cancelEditButton.addEventListener('click', () => editResourceModal.classList.remove('show'));
        
        // Écouteurs pour le formulaire d'ajout de catégorie
        addFilterPropertyButton.addEventListener('click', () => addFilterPropertyField(newCategoryFilterPropertiesContainer));
        
        // Écouteurs pour le modal d'édition de catégorie
        closeCategoryModalButton.addEventListener('click', () => editCategoryModal.classList.remove('show'));
        cancelCategoryEditButton.addEventListener('click', () => editCategoryModal.classList.remove('show'));
        addEditFilterPropertyButton.addEventListener('click', () => addFilterPropertyField(editCategoryFilterPropertiesList));
        
        
        
        // =================================================================================
        //                        FONCTIONS DE GESTION DES DONNÉES
        // =================================================================================
        
        // Fonction pour valider/rejeter une suggestion (exemple simple)
        async function handleSuggestionAction(e) {
            const card = e.target.closest('.pending-card');
            const id = card.dataset.id;
            const action = e.target.dataset.action;
            const messageArea = card.querySelector('.card-message-area');
        
            card.classList.add('fade-out');
            setTimeout(async () => {
                try {
                    const docRef = doc(db, 'pending_suggestions', id);
                    const docSnap = await getDoc(docRef);
                    const suggestion = docSnap.data();
                    
                    if (action === 'validate') {
                        // On déplace la ressource validée vers la collection principale
                        await addDoc(collection(db, 'resources'), { ...suggestion, status: 'approved', createdAt: serverTimestamp() });
                        await deleteDoc(docRef);
                        showGeneralMessage('Proposition validée avec succès.', 'success');
                    } else if (action === 'reject') {
                        // On supprime simplement la proposition rejetée
                        await deleteDoc(docRef);
                        showGeneralMessage('Proposition rejetée.', 'success');
                    }
                } catch (error) {
                    console.error("Error handling suggestion action: ", error);
                    messageArea.textContent = 'Erreur';
                    messageArea.classList.add('show', 'error');
                    showGeneralMessage('Une erreur est survenue lors du traitement.', 'error');
                    card.classList.remove('fade-out'); // Rendre la carte visible si erreur
                }
            }, 500);
        }
        
        // Gérer les clics sur les boutons de validation/rejet
        pendingSuggestionsList.addEventListener('click', (e) => {
            if (e.target.dataset.action) {
                handleSuggestionAction(e);
            }
        });
        
        // Gérer les clics sur les boutons d'édition/suppression de ressource
        resourcesList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
        
            const card = e.target.closest('.resource-card');
            const id = card.dataset.id;
            const action = button.dataset.action;
        
            if (action === 'edit') {
                try {
                    const docRef = doc(db, 'resources', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const resource = docSnap.data();
                        editResourceId.value = id;
                        editTitle.value = resource.title;
                        editDescription.value = resource.description;
                        editUrl.value = resource.url;
                        
                        // Remplir le select de catégorie
                        editCategory.innerHTML = '';
                        for (const catId in categoryConfigData) {
                            const option = document.createElement('option');
                            option.value = catId;
                            option.textContent = categoryConfigData[catId].label;
                            if (catId === resource.category) {
                                option.selected = true;
                            }
                            editCategory.appendChild(option);
                        }
                        
                        // Générer les champs spécifiques de filtre
                        generateEditSpecificFields(resource.category, resource);
        
                        editResourceModal.classList.add('show');
                    }
                } catch (error) {
                    console.error("Error opening edit modal: ", error);
                    showGeneralMessage('Erreur lors du chargement de la ressource.', 'error');
                }
            } else if (action === 'delete') {
                // Utiliser une modale de confirmation à la place de window.confirm()
                // Pour l'instant, on fait un simple delete
                try {
                    await deleteDoc(doc(db, 'resources', id));
                    showGeneralMessage('Ressource supprimée avec succès.', 'success');
                } catch (error) {
                    console.error("Error deleting resource: ", error);
                    showGeneralMessage('Erreur lors de la suppression de la ressource.', 'error');
                }
            }
        });
        
        // Gérer la soumission du formulaire d'édition de ressource
        editResourceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editResourceId.value;
            const updatedData = {
                title: editTitle.value,
                description: editDescription.value,
                url: editUrl.value,
                category: editCategory.value,
                filters: {}
            };
        
            // Collecter les valeurs des champs de filtre
            const filterInputs = editSpecificFieldsContainer.querySelectorAll('input');
            filterInputs.forEach(input => {
                const filterId = input.id.replace('edit-filter-', '');
                updatedData.filters[filterId] = input.value;
            });
        
            try {
                const docRef = doc(db, 'resources', id);
                await updateDoc(docRef, updatedData);
                editResourceModal.classList.remove('show');
                showGeneralMessage('Ressource mise à jour avec succès.', 'success');
            } catch (error) {
                console.error("Error updating resource: ", error);
                showGeneralMessage('Erreur lors de la mise à jour de la ressource.', 'error');
            }
        });
        
        // Gérer la suppression de ressource depuis le modal
        deleteResourceButton.addEventListener('click', async () => {
            const id = editResourceId.value;
            try {
                await deleteDoc(doc(db, 'resources', id));
                editResourceModal.classList.remove('show');
                showGeneralMessage('Ressource supprimée avec succès.', 'success');
            } catch (error) {
                console.error("Error deleting resource from modal: ", error);
                showGeneralMessage('Erreur lors de la suppression de la ressource.', 'error');
            }
        });
        
        // Gérer la soumission du formulaire d'ajout de catégorie
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryId = newCategoryIdInput.value;
            const categoryLabel = newCategoryLabelInput.value;
            const filters = {};
            const filterItems = newCategoryFilterPropertiesContainer.querySelectorAll('.filter-property-item');
            filterItems.forEach(item => {
                const id = item.querySelector('.filter-id-input').value;
                const label = item.querySelector('.filter-label-input').value;
                if (id && label) {
                    filters[id] = label;
                }
            });
        
            const newConfig = { ...categoryConfigData, [categoryId]: { label: categoryLabel, filters: filters } };
        
            try {
                const docRef = doc(db, 'appConfig', 'categoriesAndFilters');
                await setDoc(docRef, newConfig);
                showGeneralMessage('Catégorie ajoutée avec succès.', 'success');
                addCategoryForm.reset();
                newCategoryFilterPropertiesContainer.innerHTML = '';
            } catch (error) {
                console.error("Error adding category: ", error);
                showGeneralMessage('Erreur lors de l\'ajout de la catégorie.', 'error');
            }
        });
        
        // Gérer les clics sur les boutons d'édition/suppression de catégorie
        categoriesConfigList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
        
            const card = e.target.closest('.category-config-card');
            const id = card.dataset.id;
            const action = button.dataset.action;
        
            if (action === 'edit-category') {
                const category = categoryConfigData[id];
                if (!category) return;
        
                editCategoryKeyInput.value = id;
                editCategoryModalLabelInput.value = category.label;
                editCategoryFilterPropertiesList.innerHTML = '';
        
                if (category.filters) {
                    for (const filterId in category.filters) {
                        addFilterPropertyField(editCategoryFilterPropertiesList, filterId, category.filters[filterId]);
                    }
                }
        
                editCategoryModal.classList.add('show');
            } else if (action === 'delete-category') {
                try {
                    const updatedConfig = { ...categoryConfigData };
                    delete updatedConfig[id];
                    setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
                    showGeneralMessage('Catégorie supprimée avec succès.', 'success');
                } catch (error) {
                    console.error("Error deleting category: ", error);
                    showGeneralMessage('Erreur lors de la suppression de la catégorie.', 'error');
                }
            }
        });
        
        // Gérer la soumission du formulaire d'édition de catégorie
        editCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editCategoryKeyInput.value;
            const filters = {};
            const filterItems = editCategoryFilterPropertiesList.querySelectorAll('.filter-property-item');
            filterItems.forEach(item => {
                const filterId = item.querySelector('.filter-id-input').value;
                const filterLabel = item.querySelector('.filter-label-input').value;
                if (filterId && filterLabel) {
                    filters[filterId] = filterLabel;
                }
            });
        
            const updatedConfig = { ...categoryConfigData, [id]: { ...categoryConfigData[id], filters: filters } };
        
            try {
                await setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
                editCategoryModal.classList.remove('show');
                showGeneralMessage('Filtres de la catégorie mis à jour avec succès.', 'success');
            } catch (error) {
                console.error("Error updating category filters: ", error);
                showGeneralMessage('Erreur lors de la mise à jour des filtres.', 'error');
            }
        });
    </script>
</body>
</html>
