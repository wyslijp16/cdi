<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 50px;
        }
        /* Styles pour le bouton burger */
        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 10001; /* Au-dessus de tout */
            background-color: #4338ca; /* indigo-700 */
            color: white;
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s;
        }
        #hamburger-button:hover {
            background-color: #3730a3; /* indigo-800 */
        }
        /* Styles pour le menu latéral */
        #sidebar-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 256px; /* w-64 */
            background-color: #3730a3; /* indigo-800 */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(-100%); /* Masqué par défaut */
            transition: transform 0.3s ease-in-out;
            z-index: 10000; /* Juste en dessous du bouton burger */
            padding: 1rem;
            padding-top: 5rem; /* Espace pour le bouton burger */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #sidebar-menu.open {
            transform: translateX(0); /* Visible */
        }
        .menu-button {
            text-align: left;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            color: white;
            transition: background-color 0.2s;
            width: 100%; /* S'assure que le bouton prend toute la largeur */
        }
        .menu-button:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .menu-button.active-section-button {
            background-color: #4338ca; /* indigo-700 */
        }

        /* Ajustement du padding de la main pour ne pas être caché par le menu */
        main {
            padding-left: 1rem; /* Padding par défaut */
            transition: padding-left 0.3s ease-in-out;
        }
        /* Si le menu est ouvert, le contenu principal ne doit pas être caché */
        /* Ceci est plus complexe car le menu overlay. L'important est que le contenu soit visible. */
        /* Si le menu était "pushing", on ajusterait le padding ici. */


        .pending-card, .resource-card, .category-config-card {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .pending-card.fade-out, .resource-card.fade-out, .category-config-card.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        .pending-card h3, .resource-card h3, .category-config-card h3 {
            font-weight: 600;
            color: #4338ca;
            font-size: 1.25rem;
        }
        .pending-card p, .resource-card p, .category-config-card p {
            color: #4b5563;
        }
        .pending-card .actions, .resource-card .actions, .category-config-card .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pending-card .actions button, .resource-card .actions button, .category-config-card .actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .pending-card .actions .btn-validate, .resource-card .actions .btn-edit, .category-config-card .actions .btn-edit-category {
            background-color: #10b981; /* emerald-500 */
        }
        .pending-card .actions .btn-validate:hover, .resource-card .actions .btn-edit:hover, .category-config-card .actions .btn-edit-category:hover {
            background-color: #059669; /* emerald-600 */
        }
        .pending-card .actions .btn-reject, .resource-card .actions .btn-delete, .category-config-card .actions .btn-delete-category {
            background-color: #ef4444; /* red-500 */
        }
        .pending-card .actions .btn-reject:hover, .resource-card .actions .btn-delete:hover, .category-config-card .actions .btn-delete-category:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Styles pour le message sur la carte */
        .card-message-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            pointer-events: none;
            z-index: 10;
        }
        .card-message-area.show {
            opacity: 1;
        }
        .card-message-area.success {
            background-color: rgba(16, 185, 129, 0.9);
        }
        .card-message-area.error {
            background-color: rgba(239, 68, 68, 0.9);
        }

        /* Styles pour le modal d'édition */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            visibility: hidden;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            width: 90%;
            max-height: 90vh; /* Hauteur maximale de la modale */
            overflow-y: auto; /* Ajoute une barre de défilement si le contenu dépasse */
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        .modal-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .modal-form-group input, .modal-form-group textarea, .modal-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .modal-form-group input:focus, .modal-form-group textarea:focus, .modal-form-group select:focus {
            outline: none;
            border-color: #4338ca;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .modal-buttons .btn-save {
            background-color: #2563eb; /* blue-600 */
        }
        .modal-buttons .btn-save:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .modal-buttons .btn-cancel {
            background-color: #6b7280; /* gray-500 */
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .modal-buttons .btn-delete-resource {
            background-color: #ef4444; /* red-500 */
            margin-right: auto; /* Aligne à gauche */
        }
        .modal-buttons .btn-delete-resource:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Styles pour la gestion des filtres */
        .filter-property-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
        }
        .filter-property-item input {
            flex-grow: 1;
            margin-bottom: 0 !important; /* Override modal-form-group margin */
        }
        .filter-property-item button {
            background-color: #dc2626; /* red-600 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: normal;
        }
        
        /* Styles pour la page de connexion */
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 1rem;
        }

        .login-form-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 100%;
        }

        #unauthorized-message {
            display: none;
            color: #ef4444;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Conteneur de connexion (Visible par défaut) -->
    <div id="login-container" class="login-container">
        <div class="login-form-card">
            <h2 class="text-2xl font-bold text-center mb-6 text-indigo-700">Connexion au Panel Admin</h2>
            <form id="login-form">
                <div class="modal-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="modal-form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" required>
                </div>
                <!-- Zone d'affichage des messages de connexion -->
                <div id="login-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- Message d'accès refusé (initialement masqué) -->
    <div id="unauthorized-message" class="hidden">
        Accès refusé. Vos privilèges sont insuffisants pour accéder à cette page.
    </div>
    
    <!-- Conteneur principal du panneau d'administration (initialement masqué) -->
    <div id="admin-panel-container" class="hidden">
        <!-- Bouton Burger -->
        <button id="hamburger-button">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <!-- Menu Latéral -->
        <nav id="sidebar-menu">
            <div class="flex items-center space-x-4 mb-4">
                <div class="text-right text-sm">
                    <p class="font-bold text-lg" id="user-role-menu"></p>
                    <p class="text-gray-300" id="user-email-menu"></p>
                </div>
            </div>
            <button id="menu-btn-show-welcome" class="menu-button">Accueil</button>
            <!-- Bouton pour les propositions en attente (visible pour tous les rôles admin) -->
            <button id="menu-btn-show-pending" class="menu-button">Propositions en attente</button>
            <!-- Boutons pour les superusers seulement -->
            <div id="superuser-menu-items" class="hidden">
                <button id="menu-btn-show-manage" class="menu-button">Gérer les ressources existantes</button>
                <button id="menu-btn-show-config" class="menu-button">Gérer Catégories/Filtres</button>
            </div>
            
            <!-- Nouveau bouton pour changer le mot de passe -->
            <div class="mt-auto pt-4 border-t border-indigo-600">
                 <button id="change-password-btn" class="menu-button">
                    Changer le mot de passe
                </button>
                <button id="logout-btn" class="menu-button bg-red-500 hover:bg-red-600 mt-2">
                    Déconnexion
                </button>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8">
            <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">Panneau d'Administration CDI</h1>

            <!-- Zone d'affichage des messages généraux -->
            <div id="general-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
            
            <!-- Section de bienvenue (nouvelle section, visible par défaut) -->
            <div id="welcome-section" class="text-center bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Bienvenue sur le Panneau d'Administration du CDI !</h2>
                <p class="text-lg text-gray-700 mb-4">
                    Utilisez ce panneau pour gérer les ressources du Centre de Documentation et d'Information de L'ékip Teknik.
                </p>
                <p class="text-md text-gray-600">
                    Sélectionnez une option dans le menu latéral (cliquez sur l'icône <svg class="inline-block w-5 h-5 align-middle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> en haut à gauche) pour commencer. Vous pourrez valider ou refuser les **propositions en attente**, modifier ou supprimer les **ressources existantes**, et gérer les **catégories et leurs propriétés de filtre**.
                </p>
            </div>

            <!-- Section des propositions en attente -->
            <div id="pending-suggestions-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Propositions en attente de validation</h2>
                <div id="pending-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>
                </div>
            </div>

            <!-- Section de gestion des ressources existantes (initialement cachée) -->
            <div id="manage-resources-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Gérer les ressources existantes</h2>
                <div id="resources-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des ressources...</p>
                </div>
            </div>

            <!-- Section de gestion des catégories et filtres (initialement cachée) -->
            <div id="manage-config-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Gérer les catégories et leurs filtres</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">Catégories actuelles</h3>
                    <div id="categories-config-list" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">Chargement de la configuration...</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Ajouter une nouvelle catégorie</h3>
                    <form id="add-category-form">
                        <div class="modal-form-group">
                            <label for="new-category-id">ID de la catégorie (ex: petitions)</label>
                            <input type="text" id="new-category-id" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-label">Libellé de la catégorie (ex: Pétitions)</label>
                            <input type="text" id="new-category-label" required>
                        </div>
                        <h4 class="font-semibold mt-4 mb-2">Propriétés de filtre (ID et Libellé)</h4>
                        <div id="new-category-filter-properties">
                            <!-- Les champs de filtre seront ajoutés ici -->
                        </div>
                        <button type="button" id="add-filter-property-button" class="bg-blue-500 text-white py-2 px-4 rounded-md mt-2 hover:bg-blue-600">Ajouter une propriété de filtre</button>
                        <button type="submit" class="bg-emerald-500 text-white py-2 px-4 rounded-md mt-4 ml-2 hover:bg-emerald-600">Ajouter la catégorie</button>
                    </form>
                </div>
            </div>
            
            <!-- Modal d'édition de ressource (initialement caché) -->
            <div id="edit-resource-modal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-button" id="close-resource-modal-button">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-center text-indigo-700">Modifier la ressource</h3>
                    <form id="edit-resource-form">
                        <input type="hidden" id="edit-resource-id">
                        <div class="modal-form-group">
                            <label for="edit-title">Titre</label>
                            <input type="text" id="edit-title" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-description">Description</label>
                            <textarea id="edit-description" rows="3" required></textarea>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-url">URL</label>
                            <input type="url" id="edit-url" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="edit-category">Catégorie</label>
                            <select id="edit-category" required>
                                <!-- Les options seront chargées dynamiquement -->
                            </select>
                        </div>
                        <!-- Champs spécifiques pour l'édition (générés dynamiquement) -->
                        <div id="edit-specific-fields"></div>
                        <div class="modal-buttons">
                            <button type="button" id="delete-resource-button" class="btn-delete-resource">Supprimer la ressource</button>
                            <button type="button" id="cancel-resource-edit-button" class="btn-cancel">Annuler</button>
                            <button type="submit" class="btn-save">Sauvegarder</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal d'édition de catégorie -->
            <div id="edit-category-modal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-button" id="close-category-modal-button">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-center text-indigo-700">Modifier les filtres de la catégorie</h3>
                    <form id="edit-category-form">
                        <input type="hidden" id="edit-category-key-input">
                        <div class="modal-form-group">
                            <label for="edit-category-label-input">Libellé de la catégorie</label>
                            <input type="text" id="edit-category-label-input" required disabled>
                        </div>
                        <h4 class="font-semibold mt-4 mb-2">Propriétés de filtre (ID et Libellé)</h4>
                        <div id="edit-category-filter-properties-list">
                            <!-- Les champs de filtre seront générés dynamiquement -->
                        </div>
                        <button type="button" id="add-edit-filter-property-button" class="bg-blue-500 text-white py-2 px-4 rounded-md mt-2 hover:bg-blue-600">Ajouter une propriété de filtre</button>
                        <div class="modal-buttons">
                            <button type="button" id="delete-category-button" class="btn-delete-resource">Supprimer la catégorie</button>
                            <button type="button" id="cancel-category-edit-button" class="btn-cancel">Annuler</button>
                            <button type="submit" class="btn-save">Sauvegarder les filtres</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- NOUVELLE MODALE : Changer le mot de passe -->
            <div id="change-password-modal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-button" id="close-password-modal-button">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-center text-indigo-700">Changer le mot de passe</h3>
                    <!-- Message d'erreur/succès pour la modale de mot de passe -->
                    <div id="password-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
                    <form id="change-password-form">
                        <div class="modal-form-group">
                            <label for="current-password">Mot de passe actuel</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-password">Nouveau mot de passe</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="confirm-new-password">Confirmer le nouveau mot de passe</label>
                            <input type="password" id="confirm-new-password" required>
                        </div>
                        <div class="modal-buttons">
                            <button type="button" id="cancel-password-change-button" class="btn-cancel">Annuler</button>
                            <button type="submit" class="btn-save">Sauvegarder le nouveau mot de passe</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // Importation des fonctions nécessaires depuis les SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // VOS CONFIGURATIONS FIREBASE
        // Copiez-collez votre configuration depuis la console Firebase
        const firebaseConfig = {
            apiKey: "VOTRE_API_KEY",
            authDomain: "VOTRE_AUTH_DOMAIN",
            projectId: "VOTRE_PROJECT_ID",
            storageBucket: "VOTRE_STORAGE_BUCKET",
            messagingSenderId: "VOTRE_MESSAGING_SENDER_ID",
            appId: "VOTRE_APP_ID"
        };
        
        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Récupérer les éléments du DOM
        const loginContainer = document.getElementById('login-container');
        const adminPanelContainer = document.getElementById('admin-panel-container');
        const unauthorizedMessage = document.getElementById('unauthorized-message');
        const userEmailMenu = document.getElementById('user-email-menu');
        const userRoleMenu = document.getElementById('user-role-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const hamburgerButton = document.getElementById('hamburger-button');
        const superuserMenuItems = document.getElementById('superuser-menu-items');
        
        // Sélections de sections
        const welcomeSection = document.getElementById('welcome-section');
        const pendingSuggestionsSection = document.getElementById('pending-suggestions-section');
        const manageResourcesSection = document.getElementById('manage-resources-section');
        const manageConfigSection = document.getElementById('manage-config-section');
        
        // Gestion de la connexion
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessageArea = document.getElementById('login-message-area');

        // Gestion des propositions en attente
        const pendingSuggestionsList = document.getElementById('pending-suggestions-list');

        // Gestion des ressources existantes
        const resourcesList = document.getElementById('resources-list');
        const editResourceModal = document.getElementById('edit-resource-modal');
        const closeResourceModalButton = document.getElementById('close-resource-modal-button');
        const editResourceForm = document.getElementById('edit-resource-form');
        const deleteResourceButton = document.getElementById('delete-resource-button');
        const editResourceTitle = document.getElementById('edit-title');
        const editResourceDescription = document.getElementById('edit-description');
        const editResourceUrl = document.getElementById('edit-url');
        const editResourceCategory = document.getElementById('edit-category');
        const editSpecificFieldsContainer = document.getElementById('edit-specific-fields');
        const cancelResourceEditButton = document.getElementById('cancel-resource-edit-button');
        let currentEditingResourceId = null;
        let categoryConfigData = {};
        
        // Gestion des catégories et filtres
        const categoriesConfigList = document.getElementById('categories-config-list');
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryId = document.getElementById('new-category-id');
        const newCategoryLabel = document.getElementById('new-category-label');
        const newCategoryFilterPropertiesContainer = document.getElementById('new-category-filter-properties');
        const addFilterPropertyButton = document.getElementById('add-filter-property-button');

        // Modal d'édition de catégorie
        const editCategoryModal = document.getElementById('edit-category-modal');
        const closeCategoryModalButton = document.getElementById('close-category-modal-button');
        const cancelCategoryEditButton = document.getElementById('cancel-category-edit-button');
        const addEditFilterPropertyButton = document.getElementById('add-edit-filter-property-button');
        const editCategoryForm = document.getElementById('edit-category-form');
        const editCategoryKeyInput = document.getElementById('edit-category-key-input');
        const editCategoryLabelInput = document.getElementById('edit-category-label-input');
        const editCategoryFilterPropertiesList = document.getElementById('edit-category-filter-properties-list');
        const deleteCategoryButton = document.getElementById('delete-category-button');
        
        // Nouveaux éléments pour changer le mot de passe
        const changePasswordBtn = document.getElementById('change-password-btn');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closePasswordModalButton = document.getElementById('close-password-modal-button');
        const cancelPasswordChangeButton = document.getElementById('cancel-password-change-button');
        const changePasswordForm = document.getElementById('change-password-form');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');
        const passwordMessageArea = document.getElementById('password-message-area');

        // Variable globale pour stocker les sections
        const sections = {
            'welcome': welcomeSection,
            'pending': pendingSuggestionsSection,
            'manage': manageResourcesSection,
            'config': manageConfigSection
        };
        
        // Gérer les messages d'erreur/succès
        function showGeneralMessage(message, type) {
            const messageArea = document.getElementById('general-message-area');
            messageArea.textContent = message;
            messageArea.className = 'text-center p-3 rounded-lg mb-4';
            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            }
            messageArea.style.display = 'block';
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000); // Masquer après 5 secondes
        }
        
        // Gérer les messages d'erreur/succès pour la modale de mot de passe
        function showPasswordModalMessage(message, type) {
            passwordMessageArea.textContent = message;
            passwordMessageArea.className = 'text-center p-3 rounded-lg mb-4';
            if (type === 'success') {
                passwordMessageArea.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                passwordMessageArea.classList.add('bg-red-100', 'text-red-700');
            }
            passwordMessageArea.style.display = 'block';
            setTimeout(() => {
                passwordMessageArea.style.display = 'none';
            }, 5000); // Masquer après 5 secondes
        }
        
        // Gérer les messages d'erreur/succès pour la connexion
        function showLoginMessage(message, type) {
            loginMessageArea.textContent = message;
            loginMessageArea.className = 'text-center p-3 rounded-lg mb-4';
            if (type === 'success') {
                loginMessageArea.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                loginMessageArea.classList.add('bg-red-100', 'text-red-700');
            }
            loginMessageArea.style.display = 'block';
            setTimeout(() => {
                loginMessageArea.style.display = 'none';
            }, 5000);
        }

        // Fonction pour afficher une section et masquer les autres
        function showSection(sectionName) {
            for (const key in sections) {
                if (sections[key]) {
                    sections[key].classList.add('hidden');
                }
            }
            if (sections[sectionName]) {
                sections[sectionName].classList.remove('hidden');
            }
        
            // Gérer les boutons actifs du menu
            const menuButtons = document.querySelectorAll('.menu-button');
            menuButtons.forEach(btn => btn.classList.remove('active-section-button'));
            const activeBtn = document.querySelector(`#menu-btn-show-${sectionName}`);
            if (activeBtn) {
                activeBtn.classList.add('active-section-button');
            }
            
            // Masquer le menu après la sélection sur mobile
            sidebarMenu.classList.remove('open');
        
            // Charger les données de la section si nécessaire
            if (sectionName === 'pending') {
                loadPendingSuggestions();
            } else if (sectionName === 'manage') {
                loadExistingResources();
            } else if (sectionName === 'config') {
                loadCategoryConfig();
            }
        }
        
        // Gérer l'état d'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // L'utilisateur est connecté
                // Cacher le formulaire de connexion
                loginContainer.classList.add('hidden');
                
                try {
                    // Charger les informations de rôle depuis Firestore
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        const userRole = userData.role || 'viewer'; // Rôle par défaut
        
                        userEmailMenu.textContent = user.email;
                        userRoleMenu.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        
                        if (userRole === 'superuser') {
                            adminPanelContainer.classList.remove('hidden');
                            unauthorizedMessage.classList.add('hidden');
                            superuserMenuItems.classList.remove('hidden');
                            showSection('welcome'); // Afficher la page d'accueil par défaut
                        } else {
                            // Cacher l'interface d'administration si l'utilisateur n'est pas un superuser
                            adminPanelContainer.classList.add('hidden');
                            unauthorizedMessage.classList.remove('hidden');
                        }
                    } else {
                        // Pas de document utilisateur, donc pas de rôle défini. Accès refusé.
                        console.log("No user role found for the current user.");
                        adminPanelContainer.classList.add('hidden');
                        unauthorizedMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération du rôle de l'utilisateur:", error);
                    // Afficher le message d'accès refusé en cas d'erreur de base de données
                    adminPanelContainer.classList.add('hidden');
                    unauthorizedMessage.classList.remove('hidden');
                }
            } else {
                // L'utilisateur est déconnecté
                loginContainer.classList.remove('hidden');
                adminPanelContainer.classList.add('hidden');
                unauthorizedMessage.classList.add('hidden');
            }
        });
        
        // Gérer la soumission du formulaire de connexion
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            showLoginMessage('Connexion en cours...', 'success');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // La redirection est maintenant gérée par onAuthStateChanged
            } catch (error) {
                console.error("Erreur de connexion:", error);
                let errorMessage = "Erreur de connexion.";
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Email ou mot de passe incorrect.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email est mal formatée.";
                        break;
                    default:
                        errorMessage = `Erreur : ${error.message}`;
                }
                showLoginMessage(errorMessage, 'error');
            }
        });
        
        // Gérer les clics sur les boutons du menu
        document.getElementById('menu-btn-show-welcome').addEventListener('click', () => showSection('welcome'));
        document.getElementById('menu-btn-show-pending').addEventListener('click', () => showSection('pending'));
        document.getElementById('menu-btn-show-manage').addEventListener('click', () => showSection('manage'));
        document.getElementById('menu-btn-show-config').addEventListener('click', () => showSection('config'));
        
        // Gérer le bouton hamburger
        hamburgerButton.addEventListener('click', () => {
            sidebarMenu.classList.toggle('open');
        });

        // Gérer l'ouverture de la modale de mot de passe
        changePasswordBtn.addEventListener('click', () => {
            changePasswordModal.classList.add('show');
            sidebarMenu.classList.remove('open');
            passwordMessageArea.style.display = 'none'; // Cacher les messages précédents
        });

        // Gérer la fermeture de la modale de mot de passe
        closePasswordModalButton.addEventListener('click', () => {
            changePasswordModal.classList.remove('show');
        });
        cancelPasswordChangeButton.addEventListener('click', () => {
            changePasswordModal.classList.remove('show');
        });

        // Gérer la soumission du formulaire de changement de mot de passe
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;
            const email = user.email;

            // Vérification simple côté client
            if (newPassword !== confirmNewPassword) {
                showPasswordModalMessage('Les nouveaux mots de passe ne correspondent pas.', 'error');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(email, currentPassword);
                
                // Ré-authentifier l'utilisateur avant de changer le mot de passe
                await reauthenticateWithCredential(user, credential);
                
                // Mettre à jour le mot de passe
                await updatePassword(user, newPassword);
                
                showPasswordModalMessage('Mot de passe mis à jour avec succès.', 'success');
                changePasswordForm.reset();
                setTimeout(() => {
                    changePasswordModal.classList.remove('show');
                }, 2000);
            } catch (error) {
                console.error("Erreur de changement de mot de passe:", error);
                let errorMessage = "Erreur lors de la mise à jour du mot de passe.";
                switch(error.code) {
                    case 'auth/wrong-password':
                        errorMessage = "Le mot de passe actuel est incorrect.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Le nouveau mot de passe est trop faible.";
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = "Veuillez vous déconnecter et vous reconnecter avant de changer votre mot de passe.";
                        break;
                    default:
                        errorMessage = `Erreur : ${error.message}`;
                }
                showPasswordModalMessage(errorMessage, 'error');
            }
        });
        
        // Gérer le bouton de déconnexion
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // La redirection est gérée par l'onAuthStateChanged listener
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
            }
        });


        // Reste du code... (fonctions loadPendingSuggestions, loadExistingResources, etc.)
        // Le reste de votre code pour charger et gérer les données des différentes sections reste le même.
        // Je ne l'inclus pas ici pour ne pas surcharger la réponse, mais il doit être présent dans votre fichier.

        // Exemple de chargement des propositions en attente
        function loadPendingSuggestions() {
            const q = query(collection(db, 'resources'), where('status', '==', 'pending'));
            onSnapshot(q, (snapshot) => {
                const suggestions = snapshot.docs;
                pendingSuggestionsList.innerHTML = '';
                if (suggestions.length === 0) {
                    pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune proposition en attente.</p>';
                    return;
                }
                suggestions.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = 'pending-card';
                    card.innerHTML = `
                        <h3>${data.title}</h3>
                        <p>${data.description}</p>
                        <p class="text-sm text-gray-400">Proposé par: ${data.proposerEmail}</p>
                        <div class="actions">
                            <button class="btn-validate" data-id="${doc.id}">Valider</button>
                            <button class="btn-reject" data-id="${doc.id}">Refuser</button>
                        </div>
                    `;
                    pendingSuggestionsList.appendChild(card);
                });
            });
        }
        
        // ... Votre code existant pour la gestion des ressources ...

        // ... Votre code existant pour la gestion des catégories ...
        
        // Gérer la soumission du formulaire d'édition de catégorie
        editCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editCategoryKeyInput.value;
            const filters = {};
            const filterItems = editCategoryFilterPropertiesList.querySelectorAll('.filter-property-item');
            filterItems.forEach(item => {
                const filterId = item.querySelector('.filter-id-input').value;
                const filterLabel = item.querySelector('.filter-label-input').value;
                if (filterId && filterLabel) {
                    filters[filterId] = filterLabel;
                }
            });
        
            const updatedConfig = { ...categoryConfigData, [id]: { ...categoryConfigData[id], filters: filters } };
        
            try {
                await setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
                editCategoryModal.classList.remove('show');
                showGeneralMessage('Filtres de la catégorie mis à jour avec succès.', 'success');
            } catch (error) {
                console.error("Error updating category filters: ", error);
                showGeneralMessage('Erreur lors de la mise à jour des filtres.', 'error');
            }
        });

        // Charge la section de bienvenue par défaut au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            // Charge la configuration des catégories en premier
            onSnapshot(doc(db, 'appConfig', 'categoriesAndFilters'), (docSnap) => {
                if (docSnap.exists()) {
                    categoryConfigData = docSnap.data();
                } else {
                    categoryConfigData = {};
                }
                // showSection('welcome'); // Affiche l'écran de bienvenue une fois la config chargée
            }, (error) => {
                console.error("Error initializing category config: ", error);
                categoryConfigData = {};
                // showSection('welcome'); // Tente d'afficher même en cas d'erreur de config
            });
        });

    </script>
</body>
</html>
