<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 50px; /* Moins de padding car pas de header flottant ici */
        }
        .pending-card {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            position: relative; /* Pour positionner le message */
            overflow: hidden; /* Pour que le message ne déborde pas pendant l'animation */
            /* Nouvelle transition pour la carte elle-même */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .pending-card.fade-out {
            opacity: 0;
            transform: translateY(-20px); /* Ajoute un léger mouvement vers le haut */
        }
        .pending-card h3 {
            font-weight: 600;
            color: #4338ca;
            font-size: 1.25rem;
        }
        .pending-card p {
            color: #4b5563;
        }
        .pending-card .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pending-card .actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* rounded-full */
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .pending-card .actions .btn-validate {
            background-color: #10b981; /* emerald-500 */
        }
        .pending-card .actions .btn-validate:hover {
            background-color: #059669; /* emerald-600 */
        }
        .pending-card .actions .btn-reject {
            background-color: #ef4444; /* red-500 */
        }
        .pending-card .actions .btn-reject:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Styles pour le message sur la carte */
        .card-message-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            opacity: 0; /* Commence caché */
            transition: opacity 0.3s ease-in; /* Transition rapide pour l'apparition */
            pointer-events: none; /* Permet de cliquer à travers le message */
            z-index: 10;
        }
        .card-message-area.show {
            opacity: 1; /* Apparaît */
        }
        .card-message-area.success {
            background-color: rgba(16, 185, 129, 0.9); /* emerald-500 avec opacité */
        }
        .card-message-area.error {
            background-color: rgba(239, 68, 68, 0.9); /* red-500 avec opacité */
        }
    </style>
</head>
<body class="text-gray-800">

    <main class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">Panneau d'Administration CDI</h1>

        <h2 class="text-2xl font-bold text-center mb-6">Propositions en attente de validation</h2>
        <div id="pending-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>
        </div>

    </main>

    <script type="module">
        // Importation des fonctions nécessaires depuis les SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

        // Votre configuration Firebase (DOIT être la même que dans votre index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAKoEX-Sdn1KQ78wYZCAz001vKiRBoT46w",
            authDomain: "cdi-lfi.firebaseapp.com",
            projectId: "cdi-lfi",
            storageBucket: "cdi-lfi.firebasestorage.app",
            messagingSenderId: "626855610699",
            appId: "1:626855610699:web:3c46a96f9d77d3e150c0ce",
            measurementId: "G-EMXFSRL9W0"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app); // Analytics est initialisé mais non utilisé activement dans ce script

        // Références aux éléments DOM spécifiques au panneau admin
        const pendingSuggestionsList = document.getElementById('pending-suggestions-list');

        let unsubscribeAdminSnapshot = null; // Stocke la fonction de désabonnement de l'écouteur Firestore pour les suggestions

        // Définition des champs spécifiques pour chaque catégorie du formulaire de proposition
        // Nécessaire ici pour savoir quels champs spécifiques copier lors de la validation
        const categorySpecificFields = {
            'petitions': [
                { id: 'platform', label: 'Plateforme', type: 'text', placeholder: 'Ex: petitions.assemblee-nationale.fr' },
                { id: 'struggle', label: 'Lutte', type: 'text', placeholder: 'Ex: Politique, Santé, Social' }
            ],
            'comptes-utiles': [
                { id: 'network', label: 'Réseau', type: 'text', placeholder: 'Ex: Twitter, Facebook, YouTube' }
            ],
            'sites-utiles': [
                { id: 'type', label: 'Type de site', type: 'text', placeholder: 'Ex: Site officiel, Blog personnel, Journal' }
            ],
            'ouvrages': [
                { id: 'publisher', label: 'Éditeur', type: 'text', placeholder: 'Ex: Éditions du Seuil' }
            ]
        };

        /**
         * Affiche un message directement sur une carte et le fait disparaître progressivement avec la carte.
         * @param {HTMLElement} cardElement - L'élément de la carte sur laquelle afficher le message.
         * @param {string} message - Le message à afficher.
         * @param {string} type - Le type de message ('success' ou 'error').
         * @param {Function} onAnimationCompleteCallback - Callback à exécuter une fois l'animation terminée.
         */
        function showCardMessage(cardElement, message, type, onAnimationCompleteCallback) {
            const messageArea = cardElement.querySelector('.card-message-area');
            if (messageArea) {
                messageArea.textContent = message;
                messageArea.className = `card-message-area show ${type}`; // Ajoute les classes pour afficher et styliser

                // Après un court délai, commence à faire disparaître la carte entière
                setTimeout(() => {
                    cardElement.classList.add('fade-out'); // Ajoute la classe pour l'animation de fondu de la carte
                    // Force un reflow pour s'assurer que la transition est appliquée
                    void cardElement.offsetHeight; 

                    // Supprime la carte du DOM après la fin de son animation de transition
                    cardElement.addEventListener('transitionend', function handler(event) {
                        // S'assure que l'événement de transition est bien celui de l'opacité de la carte
                        if (event.propertyName === 'opacity') {
                            cardElement.removeEventListener('transitionend', handler); // Nettoie l'écouteur
                            // Exécute le callback (qui contient l'opération Firestore)
                            if (onAnimationCompleteCallback && typeof onAnimationCompleteCallback === 'function') {
                                onAnimationCompleteCallback();
                            }
                            // La carte sera retirée du DOM par l'écouteur onSnapshot de Firestore
                            // une fois que l'opération de suppression Firestore est terminée.
                        }
                    });
                }, 1000); // Le message est visible pendant 1 seconde, puis la carte commence à disparaître
            }
        }

        /**
         * Charge et affiche les propositions en attente de la collection 'suggestions'.
         */
        function loadPendingSuggestions() {
            pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>';

            // Se désabonne de l'écouteur précédent s'il existe
            if (unsubscribeAdminSnapshot) unsubscribeAdminSnapshot();

            // Écoute les changements en temps réel dans la collection 'suggestions'
            unsubscribeAdminSnapshot = onSnapshot(collection(db, 'suggestions'), (querySnapshot) => {
                pendingSuggestionsList.innerHTML = ''; // Efface le message de chargement

                if (querySnapshot.empty) {
                    pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune proposition en attente pour le moment.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const suggestion = docSnap.data();
                    const suggestionId = docSnap.id;

                    // Crée la carte de suggestion
                    const card = document.createElement('div');
                    card.className = 'pending-card';
                    card.setAttribute('data-id', suggestionId); // Ajoute l'ID pour un accès facile

                    // Construit le HTML de la carte
                    card.innerHTML = `
                        <h3 class="text-indigo-800">${suggestion.title}</h3>
                        <p class="text-gray-600">${suggestion.description}</p>
                        <p class="text-gray-500 text-sm"><strong>URL:</strong> <a href="${suggestion.url}" target="_blank" class="text-blue-600 hover:underline">${suggestion.url}</a></p>
                        <p class="text-gray-500 text-sm"><strong>Catégorie:</strong> ${suggestion.category}</p>
                        ${Object.keys(suggestion).filter(key => ['platform', 'struggle', 'network', 'type', 'publisher'].includes(key)).map(key => `
                            <p class="text-gray-500 text-sm"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${suggestion[key]}</p>
                        `).join('')}
                        <div class="actions">
                            <button class="btn-validate" data-id="${suggestionId}">Valider</button>
                            <button class="btn-reject" data-id="${suggestionId}">Refuser</button>
                        </div>
                        <div class="card-message-area"></div> <!-- Zone pour le message de la carte -->
                    `;
                    pendingSuggestionsList.appendChild(card);

                    // Ajoute les écouteurs d'événements aux boutons de validation/rejet
                    card.querySelector('.btn-validate').addEventListener('click', () => handleValidateSuggestion(suggestionId, suggestion, card));
                    card.querySelector('.btn-reject').addEventListener('click', () => handleRejectSuggestion(suggestionId, card));
                });
            }, (error) => {
                console.error("Error loading pending suggestions: ", error);
                pendingSuggestionsList.innerHTML = '<p class="col-span-full text-center text-red-500 text-xl mt-12">Erreur lors du chargement des propositions. Vérifiez les règles de sécurité Firestore.</p>';
            });
        }

        /**
         * Gère la validation d'une suggestion : l'ajoute aux ressources et la supprime des suggestions.
         * @param {string} suggestionId - L'ID du document de suggestion.
         * @param {object} suggestionData - Les données de la suggestion à valider.
         * @param {HTMLElement} cardElement - L'élément DOM de la carte associée à la suggestion.
         */
        async function handleValidateSuggestion(suggestionId, suggestionData, cardElement) {
            // Fonction à exécuter après l'animation de la carte
            const onAnimationComplete = async () => {
                try {
                    // Crée un objet pour les données de la ressource validée
                    const resourceData = {
                        title: suggestionData.title,
                        description: suggestionData.description,
                        url: suggestionData.url,
                        category: suggestionData.category
                    };

                    // Ajoute les champs spécifiques si présents
                    const specificFields = categorySpecificFields[suggestionData.category];
                    if (specificFields) {
                        specificFields.forEach(field => {
                            if (suggestionData[field.id]) { 
                                resourceData[field.id] = suggestionData[field.id];
                            }
                        });
                    }
                    
                    await addDoc(collection(db, 'resources'), resourceData);
                    await deleteDoc(doc(db, 'suggestions', suggestionId));
                    // La carte sera retirée du DOM par l'écouteur onSnapshot
                } catch (e) {
                    console.error("Error validating suggestion after animation: ", e);
                    // Si l'opération Firestore échoue APRÈS l'animation, vous pourriez vouloir un autre mécanisme de notification
                }
            };

            // Déclenche l'animation et passe la fonction Firestore en callback
            showCardMessage(cardElement, 'Validée !', 'success', onAnimationComplete);
        }

        /**
         * Gère le rejet d'une suggestion : la supprime des suggestions.
         * @param {string} suggestionId - L'ID du document de suggestion.
         * @param {HTMLElement} cardElement - L'élément DOM de la carte associée à la suggestion.
         */
        async function handleRejectSuggestion(suggestionId, cardElement) {
            // Fonction à exécuter après l'animation de la carte
            const onAnimationComplete = async () => {
                try {
                    await deleteDoc(doc(db, 'suggestions', suggestionId));
                    // La carte sera retirée du DOM par l'écouteur onSnapshot
                } catch (e) {
                    console.error("Error rejecting suggestion after animation: ", e);
                    // Si l'opération Firestore échoue APRÈS l'animation, vous pourriez vouloir un autre mécanisme de notification
                }
            };

            // Déclenche l'animation et passe la fonction Firestore en callback
            showCardMessage(cardElement, 'Refusée !', 'error', onAnimationComplete);
        }

        // Charge les propositions en attente au chargement de la page
        document.addEventListener('DOMContentLoaded', loadPendingSuggestions);

    </script>
</body>
</html>
