<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 50px;
        }
        /* Styles pour le bouton burger */
        #hamburger-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 10001;
            background-color: #4338ca;
            color: white;
            padding: 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s;
        }
        #hamburger-button:hover {
            background-color: #3730a3;
        }
        /* Styles pour le menu lat√©ral */
        #sidebar-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 256px;
            background-color: #3730a3;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 10000;
            padding: 1rem;
            padding-top: 5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #sidebar-menu.open {
            transform: translateX(0);
        }
        .menu-button {
            text-align: left;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            color: white;
            transition: background-color 0.2s;
            width: 100%;
        }
        .menu-button:hover {
            background-color: #4338ca;
        }
        .menu-button.active-section-button {
            background-color: #4338ca;
        }
        main {
            padding-left: 1rem;
            transition: padding-left 0.3s ease-in-out;
        }
        .pending-card, .resource-card, .category-config-card {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .pending-card.fade-out, .resource-card.fade-out, .category-config-card.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        .pending-card h3, .resource-card h3, .category-config-card h3 {
            font-weight: 600;
            color: #4338ca;
            font-size: 1.25rem;
        }
        .pending-card p, .resource-card p, .category-config-card p {
            color: #4b5563;
        }
        .pending-card .actions, .resource-card .actions, .category-config-card .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pending-card .actions button, .resource-card .actions button, .category-config-card .actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .pending-card .actions .btn-validate, .resource-card .actions .btn-edit, .category-config-card .actions .btn-edit-category {
            background-color: #10b981;
        }
        .pending-card .actions .btn-validate:hover, .resource-card .actions .btn-edit:hover, .category-config-card .actions .btn-edit-category:hover {
            background-color: #059669;
        }
        .pending-card .actions .btn-reject, .resource-card .actions .btn-delete, .category-config-card .actions .btn-delete-category {
            background-color: #ef4444;
        }
        .pending-card .actions .btn-reject:hover, .resource-card .actions .btn-delete:hover, .category-config-card .actions .btn-delete-category:hover {
            background-color: #dc2626;
        }
        .card-message-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            pointer-events: none;
            z-index: 10;
        }
        .card-message-area.show {
            opacity: 1;
        }
        .card-message-area.success {
            background-color: rgba(16, 185, 129, 0.9);
        }
        .card-message-area.error {
            background-color: rgba(239, 68, 68, 0.9);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            visibility: hidden;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        .modal-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        .modal-form-group input, .modal-form-group textarea, .modal-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .modal-form-group input:focus, .modal-form-group textarea:focus, .modal-form-group select:focus {
            outline: none;
            border-color: #4338ca;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }
        .modal-buttons .btn-save {
            background-color: #2563eb;
        }
        .modal-buttons .btn-save:hover {
            background-color: #1d4ed8;
        }
        .modal-buttons .btn-cancel {
            background-color: #6b7280;
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #4b5563;
        }
        .modal-buttons .btn-delete-resource {
            background-color: #ef4444;
            margin-right: auto;
        }
        .modal-buttons .btn-delete-resource:hover {
            background-color: #dc2626;
        }
        .filter-property-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
        }
        .filter-property-item input {
            flex-grow: 1;
            margin-bottom: 0 !important;
        }
        .filter-property-item button {
            background-color: #dc2626;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: normal;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 1rem;
        }
        .login-form-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 100%;
        }
        #unauthorized-message {
            display: none;
            color: #ef4444;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Conteneur de connexion -->
    <div id="login-container" class="login-container">
        <div class="login-form-card">
            <h2 class="text-2xl font-bold text-center mb-6 text-indigo-700">Connexion au Panel Admin</h2>
            <form id="login-form">
                <div class="modal-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="modal-form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" required>
                </div>
                <div id="login-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition">Se connecter</button>
            </form>
        </div>
    </div>
    <!-- Message d'acc√®s refus√© -->
    <div id="unauthorized-message" class="hidden">
        Acc√®s refus√©. Vos privil√®ges sont insuffisants pour acc√©der √† cette page.
    </div>
    <!-- Conteneur principal du panneau d'administration -->
    <div id="admin-panel-container" class="hidden">
        <button id="hamburger-button">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <nav id="sidebar-menu">
            <div class="flex items-center space-x-4 mb-4">
                <div class="text-right text-sm">
                    <p class="font-bold text-lg" id="user-role-menu"></p>
                    <p class="text-gray-300" id="user-email-menu"></p>
                </div>
            </div>
            <button id="menu-btn-show-welcome" class="menu-button">Accueil</button>
            <button id="menu-btn-show-pending" class="menu-button">Propositions en attente</button>
            <div id="superuser-menu-items" class="hidden">
                <button id="menu-btn-show-manage" class="menu-button">G√©rer les ressources existantes</button>
                <button id="menu-btn-show-config" class="menu-button">G√©rer Cat√©gories/Filtres</button>
            </div>
            <div class="mt-auto pt-4 border-t border-indigo-600">
                 <button id="change-password-btn" class="menu-button">
                    Changer le mot de passe
                </button>
                <button id="logout-btn" class="menu-button bg-red-500 hover:bg-red-600 mt-2">
                    D√©connexion
                </button>
            </div>
        </nav>
        <main class="container mx-auto p-4 md:p-8">
            <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">Panneau d'Administration CDI</h1>
            <div id="general-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
            <div id="welcome-section" class="text-center bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Bienvenue sur le Panneau d'Administration du CDI !</h2>
                <p class="text-lg text-gray-700 mb-4">
                    Utilisez ce panneau pour g√©rer les ressources du Centre de Documentation et d'Information de L'√©kip Teknik.
                </p>
                <p class="text-md text-gray-600">
                    S√©lectionnez une option dans le menu lat√©ral (cliquez sur l'ic√¥ne <svg class="inline-block w-5 h-5 align-middle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> en haut √† gauche) pour commencer. Vous pourrez valider ou refuser les **propositions en attente**, modifier ou supprimer les **ressources existantes**, et g√©rer les **cat√©gories et leurs propri√©t√©s de filtre**.
                </p>
            </div>
            <div id="pending-suggestions-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Propositions en attente de validation</h2>
                <div id="pending-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>
                </div>
            </div>
            <div id="manage-resources-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">G√©rer les ressources existantes</h2>
                <div id="resources-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des ressources...</p>
                </div>
            </div>
            <div id="manage-config-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">G√©rer les cat√©gories et leurs filtres</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">Cat√©gories actuelles</h3>
                    <div id="categories-config-list" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">Chargement de la configuration...</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Ajouter une nouvelle cat√©gorie</h3>
                    <form id="add-category-form">
                        <div class="modal-form-group">
                            <label for="new-category-name-input">Nom de la Cat√©gorie (ex: 'Livres')</label>
                            <input type="text" id="new-category-name-input" class="w-full" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-label-input">Label de la Cat√©gorie</label>
                            <input type="text" id="new-category-label-input" class="w-full" required>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-description-input">Description de la Cat√©gorie</label>
                            <textarea id="new-category-description-input" class="w-full" rows="2"></textarea>
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-color-input">Couleur de la Cat√©gorie</label>
                            <input type="color" id="new-category-color-input" class="w-full">
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-order-input">Ordre d'affichage</label>
                            <input type="number" id="new-category-order-input" class="w-full" min="0">
                        </div>
                        <div class="modal-form-group">
                            <label for="new-category-filter-properties">Propri√©t√©s de Filtre</label>
                            <div id="new-category-filter-properties-container">
                                <!-- Les champs de filtre seront ajout√©s ici -->
                            </div>
                            <button type="button" id="add-new-filter-property-button" class="mt-2 text-indigo-600 font-semibold text-sm">
                                + Ajouter une propri√©t√© de filtre
                            </button>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition mt-4">
                            Ajouter la Cat√©gorie
                        </button>
                    </form>
                </div>
            </div>
            <!-- Section pour changer le mot de passe -->
            <div id="change-password-section" class="hidden bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6 text-center">Changer le mot de passe</h2>
                <form id="change-password-form">
                    <div class="modal-form-group">
                        <label for="current-password-input">Mot de passe actuel</label>
                        <input type="password" id="current-password-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="new-password-input">Nouveau mot de passe</label>
                        <input type="password" id="new-password-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="confirm-new-password-input">Confirmer le nouveau mot de passe</label>
                        <input type="password" id="confirm-new-password-input" required>
                    </div>
                    <div id="password-message-area" class="text-center p-3 rounded-lg mb-4 hidden"></div>
                    <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 transition">
                        Changer le mot de passe
                    </button>
                </form>
            </div>
        </main>
    </div>
    <!-- Modale d'√©dition de ressource -->
    <div id="resource-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="close-resource-modal-button">&times;</button>
            <h3 class="text-2xl font-bold mb-4">√âditer la ressource</h3>
            <form id="resource-edit-form">
                <input type="hidden" id="edit-resource-id">
                <div class="modal-form-group">
                    <label for="edit-resource-title">Titre</label>
                    <input type="text" id="edit-resource-title" required>
                </div>
                <div class="modal-form-group">
                    <label for="edit-resource-description">Description</label>
                    <textarea id="edit-resource-description" rows="4"></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="edit-resource-link">Lien</label>
                    <input type="url" id="edit-resource-link">
                </div>
                <div class="modal-form-group">
                    <label for="edit-resource-category">Cat√©gorie</label>
                    <select id="edit-resource-category" required></select>
                </div>
                <!-- Champs de filtre g√©n√©r√©s dynamiquement -->
                <div id="edit-resource-filter-fields"></div>
                <div class="modal-buttons">
                    <button type="button" id="delete-resource-button" class="btn-delete-resource">Supprimer</button>
                    <button type="button" id="cancel-resource-edit-button" class="btn-cancel">Annuler</button>
                    <button type="submit" class="btn-save">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modale d'√©dition de cat√©gorie -->
    <div id="edit-category-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="close-category-modal-button">&times;</button>
            <h3 class="text-2xl font-bold mb-4">√âditer les filtres de la cat√©gorie <span id="edit-category-name"></span></h3>
            <form id="edit-category-form">
                <input type="hidden" id="edit-category-key-input">
                <div class="modal-form-group">
                    <label>Filtres</label>
                    <div id="edit-category-filter-properties-list">
                        <!-- Champs de filtre existants -->
                    </div>
                    <button type="button" id="add-edit-filter-property-button" class="mt-2 text-indigo-600 font-semibold text-sm">
                        + Ajouter une propri√©t√© de filtre
                    </button>
                </div>
                <div class="modal-buttons">
                    <button type="button" id="delete-category-button" class="btn-delete-resource">Supprimer la cat√©gorie</button>
                    <button type="button" id="cancel-category-edit-button" class="btn-cancel">Annuler</button>
                    <button type="submit" class="btn-save">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, updatePassword, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, updateDoc, deleteDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables globales pour l'application
    let userRole = null;
    let auth = null;
    let db = null;
    let categoryConfigData = {};

    const firebaseConfig = {
        apiKey: "AIzaSyAKoEX-Sdn1KQ78wYZCAz001vKiRBoT46w",
        authDomain: "cdi-lfi.firebaseapp.com",
        projectId: "cdi-lfi",
        storageBucket: "cdi-lfi.firebasestorage.app",
        messagingSenderId: "626855610699",
        appId: "1:626855610699:web:3c46a96f9d77d3e150c0ce",
        measurementId: "G-EMXFSRL9W0"
    };

    // Initialisation de Firebase
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);

    // R√©f√©rences DOM
    const loginContainer = document.getElementById('login-container');
    const adminPanelContainer = document.getElementById('admin-panel-container');
    const unauthorizedMessage = document.getElementById('unauthorized-message');
    const loginForm = document.getElementById('login-form');
    const loginMessageArea = document.getElementById('login-message-area');
    const logoutBtn = document.getElementById('logout-btn');
    const changePasswordBtn = document.getElementById('change-password-btn');
    const changePasswordSection = document.getElementById('change-password-section');
    const changePasswordForm = document.getElementById('change-password-form');
    const passwordMessageArea = document.getElementById('password-message-area');
    const hamburgerButton = document.getElementById('hamburger-button');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const userRoleMenu = document.getElementById('user-role-menu');
    const userEmailMenu = document.getElementById('user-email-menu');
    const superuserMenuItems = document.getElementById('superuser-menu-items');
    const generalMessageArea = document.getElementById('general-message-area');

    // R√©f√©rences pour les sections
    const sections = {
        'welcome': document.getElementById('welcome-section'),
        'pending': document.getElementById('pending-suggestions-section'),
        'manage': document.getElementById('manage-resources-section'),
        'config': document.getElementById('manage-config-section'),
        'password': document.getElementById('change-password-section')
    };
    const menuButtons = {
        'welcome': document.getElementById('menu-btn-show-welcome'),
        'pending': document.getElementById('menu-btn-show-pending'),
        'manage': document.getElementById('menu-btn-show-manage'),
        'config': document.getElementById('menu-btn-show-config'),
    };

    // Modales
    const resourceEditModal = document.getElementById('resource-edit-modal');
    const resourceEditForm = document.getElementById('resource-edit-form');
    const editResourceId = document.getElementById('edit-resource-id');
    const editResourceTitle = document.getElementById('edit-resource-title');
    const editResourceDescription = document.getElementById('edit-resource-description');
    const editResourceLink = document.getElementById('edit-resource-link');
    const editResourceCategory = document.getElementById('edit-resource-category');
    const editResourceFilterFields = document.getElementById('edit-resource-filter-fields');
    const deleteResourceButton = document.getElementById('delete-resource-button');

    const editCategoryModal = document.getElementById('edit-category-modal');
    const editCategoryForm = document.getElementById('edit-category-form');
    const editCategoryName = document.getElementById('edit-category-name');
    const editCategoryKeyInput = document.getElementById('edit-category-key-input');
    const editCategoryLabelInput = document.getElementById('edit-category-label-input');
    const editCategoryDescriptionInput = document.getElementById('edit-category-description-input');
    const editCategoryColorInput = document.getElementById('edit-category-color-input');
    const editCategoryOrderInput = document.getElementById('edit-category-order-input');
    const editCategoryFilterPropertiesList = document.getElementById('edit-category-filter-properties-list');
    const addEditFilterPropertyButton = document.getElementById('add-edit-filter-property-button');
    const deleteCategoryButton = document.getElementById('delete-category-button');

    const pendingSuggestionsList = document.getElementById('pending-suggestions-list');
    const resourcesList = document.getElementById('resources-list');
    const categoriesConfigList = document.getElementById('categories-config-list');
    const addCategoryForm = document.getElementById('add-category-form');
    const newCategoryNameInput = document.getElementById('new-category-name-input');
    const newCategoryLabelInput = document.getElementById('new-category-label-input');
    const newCategoryDescriptionInput = document.getElementById('new-category-description-input');
    const newCategoryColorInput = document.getElementById('new-category-color-input');
    const newCategoryOrderInput = document.getElementById('new-category-order-input');
    const newCategoryFilterPropertiesContainer = document.getElementById('new-category-filter-properties-container');
    const addNewFilterPropertyButton = document.getElementById('add-new-filter-property-button');

    // Fonction d'affichage des messages g√©n√©raux
    function showGeneralMessage(message, type) {
        generalMessageArea.textContent = message;
        generalMessageArea.className = `text-center p-3 rounded-lg mb-4 text-white font-bold`;
        if (type === 'success') {
            generalMessageArea.classList.add('bg-green-500');
        } else if (type === 'error') {
            generalMessageArea.classList.add('bg-red-500');
        }
        generalMessageArea.classList.remove('hidden');
        setTimeout(() => {
            generalMessageArea.classList.add('hidden');
        }, 5000);
    }

    // Fonction pour afficher une section et cacher les autres
    function showSection(sectionName) {
        Object.values(sections).forEach(section => section.classList.add('hidden'));
        if (sections[sectionName]) {
            sections[sectionName].classList.remove('hidden');
        }
        Object.values(menuButtons).forEach(btn => btn.classList.remove('active-section-button'));
        if (menuButtons[sectionName]) {
            menuButtons[sectionName].classList.add('active-section-button');
        }

        if (sectionName === 'pending') {
            loadPendingSuggestions();
        } else if (sectionName === 'manage') {
            loadExistingResources();
        } else if (sectionName === 'config') {
            renderCategoryConfig();
        }
    }

    // Fonction pour afficher le contenu du panneau d'administration apr√®s l'authentification
    function showAdminPanel(user) {
        loginContainer.classList.add('hidden');
        unauthorizedMessage.classList.add('hidden');
        adminPanelContainer.classList.remove('hidden');

        // Mise √† jour de l'UI avec les infos de l'utilisateur
        userEmailMenu.textContent = user.email;

        // Masquer les √©l√©ments superuser par d√©faut
        superuserMenuItems.classList.add('hidden');

        // R√©cup√©ration du r√¥le de l'utilisateur
        const userDocRef = doc(db, 'users', user.uid);
        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().role === 'superuser') {
                userRole = 'superuser';
                userRoleMenu.textContent = 'Superuser';
                superuserMenuItems.classList.remove('hidden');
            } else {
                userRole = 'user';
                userRoleMenu.textContent = 'Admin';
            }
            // Charger la section de bienvenue par d√©faut une fois le r√¥le connu
            showSection('welcome');
        }, (error) => {
            console.error("Error getting user role: ", error);
            userRole = 'user';
            userRoleMenu.textContent = 'Admin';
            showSection('welcome');
        });
    }

    // Fonction pour afficher la page de connexion
    function showLoginPage() {
        loginContainer.classList.remove('hidden');
        adminPanelContainer.classList.add('hidden');
        unauthorizedMessage.classList.add('hidden');
        userRole = null;
    }

    // Fonction pour afficher un message d'erreur d'acc√®s
    function showUnauthorizedPage() {
        loginContainer.classList.add('hidden');
        adminPanelContainer.classList.add('hidden');
        unauthorizedMessage.classList.remove('hidden');
        userRole = null;
    }

    // G√©rer l'authentification au chargement
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDocRef = doc(db, 'users', user.uid);
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && (userDocSnap.data().role === 'superuser' || userDocSnap.data().role === 'admin')) {
                    showAdminPanel(user);
                } else {
                    showUnauthorizedPage();
                }
            } catch (error) {
                console.error("Error checking user role: ", error);
                showUnauthorizedPage();
            }
        } else {
            showLoginPage();
        }
    });

    // G√©rer la connexion
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm['login-email'].value;
        const password = loginForm['login-password'].value;
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            const userDocRef = doc(db, 'users', user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists() && (userDocSnap.data().role === 'superuser' || userDocSnap.data().role === 'admin')) {
                showGeneralMessage('Connexion r√©ussie!', 'success');
            } else {
                await signOut(auth); // D√©connecte l'utilisateur non autoris√©
                showUnauthorizedPage();
            }
        } catch (error) {
            console.error("Login error:", error);
            loginMessageArea.textContent = `Erreur de connexion : ${error.message}`;
            loginMessageArea.classList.remove('hidden');
            loginMessageArea.classList.remove('bg-green-500');
            loginMessageArea.classList.add('bg-red-500', 'text-white');
        }
    });

    // G√©rer la d√©connexion
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showGeneralMessage('D√©connexion r√©ussie!', 'success');
        } catch (error) {
            showGeneralMessage('Erreur de d√©connexion.', 'error');
            console.error("Logout error: ", error);
        }
    });

    // G√©rer le changement de mot de passe
    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = changePasswordForm['current-password-input'].value;
        const newPassword = changePasswordForm['new-password-input'].value;
        const confirmNewPassword = changePasswordForm['confirm-new-password-input'].value;

        if (newPassword !== confirmNewPassword) {
            passwordMessageArea.textContent = "Les nouveaux mots de passe ne correspondent pas.";
            passwordMessageArea.classList.add('bg-red-500', 'text-white');
            passwordMessageArea.classList.remove('hidden');
            return;
        }

        if (newPassword.length < 6) {
            passwordMessageArea.textContent = "Le nouveau mot de passe doit contenir au moins 6 caract√®res.";
            passwordMessageArea.classList.add('bg-red-500', 'text-white');
            passwordMessageArea.classList.remove('hidden');
            return;
        }

        try {
            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);
            showGeneralMessage('Mot de passe chang√© avec succ√®s!', 'success');
            showSection('welcome'); // Retour √† la page d'accueil
            passwordMessageArea.classList.add('hidden');
            changePasswordForm.reset();
        } catch (error) {
            console.error("Erreur de changement de mot de passe: ", error);
            passwordMessageArea.textContent = `Erreur de changement de mot de passe: ${error.message}`;
            passwordMessageArea.classList.add('bg-red-500', 'text-white');
            passwordMessageArea.classList.remove('hidden');
        }
    });

    // Toggle du menu lat√©ral
    hamburgerButton.addEventListener('click', () => {
        sidebarMenu.classList.toggle('open');
    });

    // Cacher le menu lat√©ral au clic sur un bouton
    document.querySelectorAll('.menu-button').forEach(button => {
        button.addEventListener('click', () => {
            sidebarMenu.classList.remove('open');
        });
    });

    // --- Fonctions de gestion des ressources et suggestions ---

    // Cr√©er un √©l√©ment de carte pour une ressource/suggestion
    function createCardElement(data, isPending) {
        const card = document.createElement('div');
        card.className = `${isPending ? 'pending-card' : 'resource-card'} relative group`;
        card.innerHTML = `
            <div class="card-message-area"></div>
            <h3 class="font-bold text-lg text-indigo-700">${data.title}</h3>
            <p class="text-sm text-gray-600">${data.description}</p>
            ${data.link ? `<p class="text-xs text-indigo-500 truncate"><a href="${data.link}" target="_blank">${data.link}</a></p>` : ''}
            <p class="text-xs text-gray-400">Cat√©gorie: ${data.category}</p>
            <div class="actions mt-4">
                ${isPending ? `<button class="btn-validate bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">Valider</button>` : ''}
                ${isPending ? `<button class="btn-reject bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">Rejeter</button>` : ''}
                ${!isPending ? `<button class="btn-edit bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">√âditer</button>` : ''}
                ${!isPending ? `<button class="btn-delete bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">Supprimer</button>` : ''}
            </div>
        `;
        if (isPending) {
            card.querySelector('.btn-validate').addEventListener('click', () => handleValidation(card, data.id, true));
            card.querySelector('.btn-reject').addEventListener('click', () => handleValidation(card, data.id, false));
        } else {
            card.querySelector('.btn-edit').addEventListener('click', () => handleEditResource(data));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteResource(data.id, card));
        }
        return card;
    }

    // Fonction pour g√©rer la validation/rejet d'une suggestion
    async function handleValidation(cardElement, docId, isAccepted) {
        const messageArea = cardElement.querySelector('.card-message-area');
        cardElement.classList.add('fade-out');

        try {
            // R√©cup√©rer les donn√©es AVANT suppression
            const suggestionRef = doc(db, 'suggestions', docId);
            const suggestionSnap = await getDoc(suggestionRef);
            const suggestionData = suggestionSnap.exists() ? suggestionSnap.data() : null;

            // Supprimer la suggestion de la collection "suggestions"
            await deleteDoc(suggestionRef);

            if (isAccepted && suggestionData) {
                // Si accept√©e, ajouter √† la collection "resources"
                const resourceRef = collection(db, 'resources');
                await addDoc(resourceRef, suggestionData);
                messageArea.textContent = 'Valid√©!';
                messageArea.classList.add('success', 'show');
            } else {
                messageArea.textContent = 'Rejet√©!';
                messageArea.classList.add('error', 'show');
            }
            
            // Attendre l'animation de fade-out puis supprimer l'√©l√©ment
            setTimeout(() => {
                if (cardElement.parentNode) {
                    cardElement.parentNode.removeChild(cardElement);
                }
            }, 500);

        } catch (error) {
            console.error("Erreur lors de la validation/rejet: ", error);
            messageArea.textContent = 'Erreur!';
            messageArea.classList.add('error', 'show');
            cardElement.classList.remove('fade-out');
            setTimeout(() => messageArea.classList.remove('show'), 3000);
        }
    }

    // Fonction pour charger et afficher les suggestions en attente
    function loadPendingSuggestions() {
        pendingSuggestionsList.innerHTML = `<p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des propositions...</p>`;
        const suggestionsRef = collection(db, 'suggestions');
        onSnapshot(suggestionsRef, (querySnapshot) => {
            pendingSuggestionsList.innerHTML = '';
            const pendingCount = querySnapshot.docs.length;
            if (pendingCount === 0) {
                pendingSuggestionsList.innerHTML = `<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune proposition en attente pour le moment.</p>`;
                return;
            }
            querySnapshot.forEach((doc) => {
                const data = { id: doc.id, ...doc.data() };
                const card = createCardElement(data, true);
                pendingSuggestionsList.appendChild(card);
            });
        }, (error) => {
            console.error("Error loading pending suggestions: ", error);
            pendingSuggestionsList.innerHTML = `<p class="col-span-full text-center text-red-500 text-xl mt-12">Erreur lors du chargement des propositions.</p>`;
        });
    }

    // Fonction pour charger et afficher les ressources existantes
    function loadExistingResources() {
        resourcesList.innerHTML = `<p class="col-span-full text-center text-gray-500 text-xl mt-12">Chargement des ressources...</p>`;
        const resourcesRef = collection(db, 'resources');
        onSnapshot(resourcesRef, (querySnapshot) => {
            resourcesList.innerHTML = '';
            const resourceCount = querySnapshot.docs.length;
            if (resourceCount === 0) {
                resourcesList.innerHTML = `<p class="col-span-full text-center text-gray-500 text-xl mt-12">Aucune ressource existante.</p>`;
                return;
            }
            querySnapshot.forEach((doc) => {
                const data = { id: doc.id, ...doc.data() };
                const card = createCardElement(data, false);
                resourcesList.appendChild(card);
            });
        }, (error) => {
            console.error("Error loading existing resources: ", error);
            resourcesList.innerHTML = `<p class="col-span-full text-center text-red-500 text-xl mt-12">Erreur lors du chargement des ressources.</p>`;
        });
    }

    // Fonction pour g√©n√©rer dynamiquement les champs de filtre d'une ressource
    function renderResourceFilterFields(resourceData, targetElement) {
        targetElement.innerHTML = '';
        const filtersArray = categoryConfigData[resourceData.category];
        if (Array.isArray(filtersArray)) {
            filtersArray.forEach(filterObj => {
                const fieldValue = resourceData.filters ? (resourceData.filters[filterObj.id] || '') : '';
                const filterGroup = document.createElement('div');
                filterGroup.className = 'modal-form-group';
                filterGroup.innerHTML = `
                    <label for="edit-resource-${filterObj.id}">${filterObj.label}</label>
                    <input type="text" id="edit-resource-${filterObj.id}" data-filter-id="${filterObj.id}" value="${fieldValue}">
                `;
                targetElement.appendChild(filterGroup);
            });
        }
    }

    // G√©rer le clic sur le bouton "√âditer" d'une ressource
    function handleEditResource(resourceData) {
        editResourceId.value = resourceData.id;
        editResourceTitle.value = resourceData.title;
        editResourceDescription.value = resourceData.description;
        editResourceLink.value = resourceData.link;

        // Remplir le select des cat√©gories
        editResourceCategory.innerHTML = '';
        for (const key in categoryConfigData) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key; // Utilise la cl√© comme label
            editResourceCategory.appendChild(option);
        }
        editResourceCategory.value = resourceData.category;

        // Rendre les champs de filtre
        renderResourceFilterFields(resourceData, editResourceFilterFields);

        // G√©rer le changement de cat√©gorie pour mettre √† jour les filtres
        editResourceCategory.onchange = () => {
            const newCategory = editResourceCategory.value;
            const newResourceData = { ...resourceData, category: newCategory };
            renderResourceFilterFields(newResourceData, editResourceFilterFields);
        };

        resourceEditModal.classList.add('show');
    }

    // G√©rer la soumission du formulaire d'√©dition de ressource
    resourceEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const resourceId = editResourceId.value;
        const updatedResource = {
            title: editResourceTitle.value,
            description: editResourceDescription.value,
            link: editResourceLink.value,
            category: editResourceCategory.value,
            filters: {}
        };

        // Collecter les valeurs des filtres dynamiques
        editResourceFilterFields.querySelectorAll('input').forEach(input => {
            const filterId = input.dataset.filterId;
            if (filterId) {
                updatedResource.filters[filterId] = input.value;
            }
        });

        try {
            const resourceDocRef = doc(db, 'resources', resourceId);
            await updateDoc(resourceDocRef, updatedResource);
            showGeneralMessage('Ressource mise √† jour avec succ√®s.', 'success');
            resourceEditModal.classList.remove('show');
        } catch (error) {
            console.error("Error updating resource: ", error);
            showGeneralMessage('Erreur lors de la mise √† jour de la ressource.', 'error');
        }
    });

    // G√©rer la suppression d'une ressource
    deleteResourceButton.addEventListener('click', async () => {
        const resourceId = editResourceId.value;
        if (confirm("√ätes-vous s√ªr de vouloir supprimer cette ressource ?")) {
            try {
                const resourceDocRef = doc(db, 'resources', resourceId);
                await deleteDoc(resourceDocRef);
                showGeneralMessage('Ressource supprim√©e avec succ√®s.', 'success');
                resourceEditModal.classList.remove('show');
            } catch (error) {
                console.error("Error deleting resource: ", error);
                showGeneralMessage('Erreur lors de la suppression de la ressource.', 'error');
            }
        }
    });

    // Fermer la modale d'√©dition de ressource
    document.getElementById('close-resource-modal-button').addEventListener('click', () => resourceEditModal.classList.remove('show'));
    document.getElementById('cancel-resource-edit-button').addEventListener('click', () => resourceEditModal.classList.remove('show'));

    // --- Fonctions de gestion des cat√©gories et filtres ---

    // Fonction pour cr√©er un √©l√©ment de carte pour une cat√©gorie
    function createCategoryConfigCard(key, data) {
        const label = key; // Utilise la cl√© comme label
        const card = document.createElement('div');
        card.className = 'category-config-card';
        card.innerHTML = `
            <h3 class="font-bold text-lg text-indigo-700">${label}</h3>
            <p class="text-sm text-gray-600">ID: ${key}</p>
            <div class="actions mt-4">
                <button class="btn-edit-category bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">G√©rer les filtres</button>
            </div>
        `;
        card.querySelector('.btn-edit-category').addEventListener('click', () => handleEditCategory(key, data));
        return card;
    }

    // Fonction pour charger et afficher la configuration des cat√©gories
    function renderCategoryConfig() {
        categoriesConfigList.innerHTML = `<p class="text-gray-500">Chargement de la configuration...</p>`;
        if (Object.keys(categoryConfigData).length === 0) {
            categoriesConfigList.innerHTML = `<p class="text-gray-500">Aucune cat√©gorie configur√©e.</p>`;
            return;
        }
        categoriesConfigList.innerHTML = '';
        for (const key in categoryConfigData) {
            const card = createCategoryConfigCard(key, categoryConfigData[key]);
            categoriesConfigList.appendChild(card);
        }
    }

    // Fonction pour ajouter un champ de propri√©t√© de filtre
    function addFilterPropertyField(container) {
        const newItem = document.createElement('div');
        newItem.className = 'filter-property-item';
        newItem.innerHTML = `
            <input type="text" placeholder="ID du filtre (ex: 'auteur')" class="filter-id-input w-1/2" required>
            <input type="text" placeholder="Label du filtre (ex: 'Auteur')" class="filter-label-input w-1/2" required>
            <button type="button" class="text-white bg-red-600 px-2 py-1 rounded">
                &times;
            </button>
        `;
        newItem.querySelector('button').addEventListener('click', () => newItem.remove());
        container.appendChild(newItem);
    }

    // G√©rer le clic sur le bouton "Ajouter une propri√©t√© de filtre" pour la cr√©ation de cat√©gorie
    addNewFilterPropertyButton.addEventListener('click', () => addFilterPropertyField(newCategoryFilterPropertiesContainer));

    // G√©rer la soumission du formulaire d'ajout de cat√©gorie
    addCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const categoryName = newCategoryNameInput.value.trim();
        const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
        const filters = [];
        const filterItems = newCategoryFilterPropertiesContainer.querySelectorAll('.filter-property-item');
        filterItems.forEach(item => {
            const filterId = item.querySelector('.filter-id-input').value;
            const filterLabel = item.querySelector('.filter-label-input').value;
            if (filterId && filterLabel) {
                filters.push({
                    id: filterId,
                    label: filterLabel,
                    placeholder: "",
                    type: "text"
                });
            }
        });

        if (!categoryId || filters.length === 0) {
            showGeneralMessage("Le nom de la cat√©gorie et au moins un filtre sont requis.", 'error');
            return;
        }

        const updatedConfig = {
            ...categoryConfigData,
            [categoryId]: filters
        };
        
        try {
            await setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
            showGeneralMessage('Cat√©gorie ajout√©e avec succ√®s.', 'success');
            addCategoryForm.reset();
            newCategoryFilterPropertiesContainer.innerHTML = '';
        } catch (error) {
            console.error("Error adding category: ", error);
            showGeneralMessage('Erreur lors de l\'ajout de la cat√©gorie.', 'error');
        }
    });

    // G√©rer l'√©dition d'une cat√©gorie
    function handleEditCategory(key, data) {
        editCategoryName.textContent = key;
        editCategoryKeyInput.value = key;
        editCategoryLabelInput.value = data.label || '';
        editCategoryDescriptionInput.value = data.description || '';
        editCategoryColorInput.value = data.color || '#000000';
        editCategoryOrderInput.value = data.order || '';

        editCategoryFilterPropertiesList.innerHTML = '';
        if (Array.isArray(data.filters)) {
            data.filters.forEach(filterObj => {
                const newItem = document.createElement('div');
                newItem.className = 'filter-property-item';
                newItem.innerHTML = `
                    <input type="text" value="${filterObj.id}" class="filter-id-input w-1/2" required>
                    <input type="text" value="${filterObj.label}" class="filter-label-input w-1/2" required>
                    <button type="button" class="text-white bg-red-600 px-2 py-1 rounded">
                        &times;
                    </button>
                `;
                newItem.querySelector('button').addEventListener('click', () => newItem.remove());
                editCategoryFilterPropertiesList.appendChild(newItem);
            });
        }
        editCategoryModal.classList.add('show');
    }

    // G√©rer la soumission du formulaire d'√©dition de cat√©gorie
    editCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = editCategoryKeyInput.value;
        const label = editCategoryLabelInput.value;
        const description = editCategoryDescriptionInput.value;
        const color = editCategoryColorInput.value;
        const order = editCategoryOrderInput.value;
        const filters = [];
        const filterItems = editCategoryFilterPropertiesList.querySelectorAll('.filter-property-item');
        filterItems.forEach(item => {
            const filterId = item.querySelector('.filter-id-input').value;
            const filterLabel = item.querySelector('.filter-label-input').value;
            if (filterId && filterLabel) {
                filters.push({
                    id: filterId,
                    label: filterLabel,
                    placeholder: "",
                    type: "text"
                });
            }
        });

        const updatedConfig = { ...categoryConfigData, [id]: { label, description, color, order, filters } };

        try {
            await setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
            editCategoryModal.classList.remove('show');
            showGeneralMessage('Filtres de la cat√©gorie mis √† jour avec succ√®s.', 'success');
        } catch (error) {
            console.error("Error updating category filters: ", error);
            showGeneralMessage('Erreur lors de la mise √† jour des filtres.', 'error');
        }
    });

    // G√©rer la suppression de cat√©gorie
    deleteCategoryButton.addEventListener('click', async () => {
        const id = editCategoryKeyInput.value;
        if (confirm(`√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${id}" ?`)) {
            const updatedConfig = { ...categoryConfigData };
            delete updatedConfig[id];

            try {
                await setDoc(doc(db, 'appConfig', 'categoriesAndFilters'), updatedConfig);
                editCategoryModal.classList.remove('show');
                showGeneralMessage('Cat√©gorie supprim√©e avec succ√®s.', 'success');
            } catch (error) {
                console.error("Erreur lors de la suppression de la cat√©gorie: ", error);
                showGeneralMessage('Erreur lors de la suppression de la cat√©gorie.', 'error');
            }
        }
    });

    // Fermer la modale d'√©dition de cat√©gorie
    document.getElementById('close-category-modal-button').addEventListener('click', () => editCategoryModal.classList.remove('show'));
    document.getElementById('cancel-category-edit-button').addEventListener('click', () => editCategoryModal.classList.remove('show'));
    addEditFilterPropertyButton.addEventListener('click', () => addFilterPropertyField(editCategoryFilterPropertiesList));

    // Listeners pour les boutons du menu
    document.getElementById('menu-btn-show-welcome').addEventListener('click', () => showSection('welcome'));
    document.getElementById('menu-btn-show-pending').addEventListener('click', () => showSection('pending'));
    document.getElementById('menu-btn-show-manage').addEventListener('click', () => showSection('manage'));
    document.getElementById('menu-btn-show-config').addEventListener('click', () => showSection('config'));
    document.getElementById('change-password-btn').addEventListener('click', () => showSection('password'));

    // Chargement de la configuration des cat√©gories au d√©marrage de l'application
    function loadCategoryConfig() {
        onSnapshot(doc(db, 'appConfig', 'categoriesAndFilters'), (docSnap) => {
            if (docSnap.exists()) {
                categoryConfigData = docSnap.data();
            } else {
                categoryConfigData = {};
            }
            // Si la section de configuration est affich√©e, la mettre √† jour
            if (!sections['config'].classList.contains('hidden')) {
                renderCategoryConfig();
            }
        }, (error) => {
            console.error("Error initializing category config: ", error);
            categoryConfigData = {};
        });
    }

    // Chargement initial de la configuration
    loadCategoryConfig();
    </script>
</body>
</html>